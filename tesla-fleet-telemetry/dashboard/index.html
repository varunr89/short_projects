<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tesla Fleet Telemetry Dashboard</title>
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg: #0d1117;
      --bg-card: #161b22;
      --border: #30363d;
      --text: #c9d1d9;
      --text-muted: #8b949e;
      --accent: #58a6ff;
      --accent-dim: rgba(88, 166, 255, 0.15);
      --green: #3fb950;
      --orange: #d29922;
      --red: #f85149;
      --font: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font);
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }

    /* Header */
    .header {
      text-align: center;
      margin-bottom: 2.5rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    .header h1 {
      font-size: 2rem;
      font-weight: 700;
      color: #f0f6fc;
      letter-spacing: -0.02em;
    }

    .header .subtitle {
      color: var(--text-muted);
      font-size: 1.1rem;
      margin-top: 0.25rem;
    }

    .header .last-updated {
      color: var(--text-muted);
      font-size: 0.85rem;
      margin-top: 0.5rem;
    }

    /* Loading & Error States */
    .loading-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 4rem 2rem;
      text-align: center;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 1.5rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-state .status-text {
      color: var(--text-muted);
      font-size: 1rem;
    }

    .loading-state .progress-detail {
      color: var(--text-muted);
      font-size: 0.85rem;
      margin-top: 0.5rem;
      opacity: 0.7;
    }

    .error-state {
      background: rgba(248, 81, 73, 0.1);
      border: 1px solid rgba(248, 81, 73, 0.3);
      border-radius: 8px;
      padding: 2rem;
      text-align: center;
      margin: 2rem 0;
    }

    .error-state h3 {
      color: var(--red);
      margin-bottom: 0.5rem;
    }

    .error-state p {
      color: var(--text-muted);
      font-size: 0.95rem;
    }

    .error-state .error-detail {
      font-family: monospace;
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 1rem;
      padding: 0.75rem;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 4px;
      word-break: break-all;
    }

    /* Dashboard Content */
    .dashboard {
      display: none;
    }

    .dashboard.visible {
      display: block;
    }

    /* Chart Cards */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.25rem;
      margin-bottom: 1.25rem;
    }

    .card h3 {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 1rem;
    }

    .card .chart-container {
      position: relative;
      width: 100%;
      height: 280px;
    }

    .card .chart-container.tall {
      height: 320px;
    }

    /* Stats Cards Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin-bottom: 1.25rem;
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.25rem;
      text-align: center;
    }

    .stat-card .stat-value {
      font-size: 1.75rem;
      font-weight: 700;
      color: #f0f6fc;
      line-height: 1.2;
    }

    .stat-card .stat-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-top: 0.35rem;
    }

    /* Two-column layout for battery + speed */
    .two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.25rem;
    }

    /* Signal Explorer */
    .explorer-controls {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .explorer-controls label {
      font-size: 0.9rem;
      color: var(--text-muted);
      white-space: nowrap;
    }

    .explorer-controls select {
      flex: 1;
      max-width: 400px;
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.5rem 0.75rem;
      font-size: 0.9rem;
      font-family: var(--font);
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238b949e' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      padding-right: 2rem;
    }

    .explorer-controls select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-dim);
    }

    .signal-count {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    /* Footer */
    .footer {
      text-align: center;
      padding-top: 2rem;
      margin-top: 2rem;
      border-top: 1px solid var(--border);
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .footer a {
      color: var(--accent);
      text-decoration: none;
    }

    .footer a:hover {
      text-decoration: underline;
    }

    .footer .footer-line {
      margin-bottom: 0.35rem;
    }

    /* No data state */
    .no-data {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 200px;
      color: var(--text-muted);
      font-size: 0.95rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 1.25rem 1rem;
      }

      .header h1 {
        font-size: 1.5rem;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .two-col {
        grid-template-columns: 1fr;
      }

      .stat-card .stat-value {
        font-size: 1.35rem;
      }

      .explorer-controls {
        flex-direction: column;
        align-items: stretch;
      }

      .explorer-controls select {
        max-width: 100%;
      }
    }

    @media (max-width: 480px) {
      .stats-grid {
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>Tesla Fleet Telemetry</h1>
      <div class="subtitle">Real-time data from my Model Y</div>
      <div class="last-updated" id="lastUpdated"></div>
    </div>

    <!-- Loading State -->
    <div class="loading-state" id="loadingState">
      <div class="spinner"></div>
      <div class="status-text" id="loadingStatus">Loading dashboard...</div>
      <div class="progress-detail" id="loadingDetail">Fetching stats</div>
    </div>

    <!-- Error State -->
    <div class="error-state" id="errorState" style="display:none;">
      <h3>Unable to load dashboard</h3>
      <p>Dashboard data not available. The data pipeline may be updating.</p>
      <div class="error-detail" id="errorDetail"></div>
    </div>

    <!-- Dashboard Content -->
    <div class="dashboard" id="dashboard">
      <!-- Data Coverage (full width) -->
      <div class="card">
        <h3>Data Coverage</h3>
        <div class="chart-container tall">
          <canvas id="coverageChart"></canvas>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="statRecords">N/A</div>
          <div class="stat-label">Total Records</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statDays">N/A</div>
          <div class="stat-label">Days Collecting</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statSignals">N/A</div>
          <div class="stat-label">Unique Signals</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statMiles">N/A</div>
          <div class="stat-label">Lifetime Miles</div>
        </div>
      </div>

      <!-- Battery + Speed (two column) -->
      <div class="two-col">
        <div class="card">
          <h3>Battery Level (7 days)</h3>
          <div class="chart-container">
            <canvas id="batteryChart"></canvas>
          </div>
        </div>
        <div class="card">
          <h3>Vehicle Speed (7 days)</h3>
          <div class="chart-container">
            <canvas id="speedChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Signal Explorer (full width) -->
      <div class="card">
        <h3>Signal Explorer</h3>
        <div class="explorer-controls">
          <label for="signalSelect">Signal:</label>
          <select id="signalSelect"></select>
          <span class="signal-count" id="signalCount"></span>
        </div>
        <div class="chart-container tall">
          <canvas id="explorerChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer" id="footer" style="display:none;">
      <div class="footer-line" id="footerUpdated"></div>
      <div class="footer-line">Powered by Tesla Fleet Telemetry API</div>
      <div class="footer-line">
        <a href="https://me.bhavanaai.com/blog/tesla-fleet-telemetry">Read the blog post</a>
      </div>
    </div>
  </div>

  <!-- Dependencies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js"></script>

  <script>
    // -----------------------------------------------------------------------
    // Configuration
    // -----------------------------------------------------------------------
    const BLOB_BASE = 'https://teslatelemetrybackups.blob.core.windows.net/dashboard';
    const STATS_URL = BLOB_BASE + '/stats.json';
    const DB_URL = BLOB_BASE + '/dashboard.db.gz';
    const SQL_WASM_URL = 'https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.wasm';

    // -----------------------------------------------------------------------
    // Chart.js global dark theme defaults
    // -----------------------------------------------------------------------
    Chart.defaults.color = '#8b949e';
    Chart.defaults.borderColor = '#30363d';
    Chart.defaults.font.family = "system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif";
    Chart.defaults.plugins.legend.labels.usePointStyle = true;
    Chart.defaults.plugins.legend.labels.pointStyleWidth = 10;
    Chart.defaults.plugins.tooltip.backgroundColor = '#1c2128';
    Chart.defaults.plugins.tooltip.borderColor = '#30363d';
    Chart.defaults.plugins.tooltip.borderWidth = 1;
    Chart.defaults.plugins.tooltip.titleColor = '#f0f6fc';
    Chart.defaults.plugins.tooltip.bodyColor = '#c9d1d9';
    Chart.defaults.plugins.tooltip.cornerRadius = 6;
    Chart.defaults.plugins.tooltip.padding = 10;

    // -----------------------------------------------------------------------
    // DOM references
    // -----------------------------------------------------------------------
    var $loading = document.getElementById('loadingState');
    var $loadingStatus = document.getElementById('loadingStatus');
    var $loadingDetail = document.getElementById('loadingDetail');
    var $error = document.getElementById('errorState');
    var $errorDetail = document.getElementById('errorDetail');
    var $dashboard = document.getElementById('dashboard');
    var $footer = document.getElementById('footer');
    var $lastUpdated = document.getElementById('lastUpdated');

    // -----------------------------------------------------------------------
    // State
    // -----------------------------------------------------------------------
    var db = null;
    var stats = null;
    var explorerChart = null;

    // -----------------------------------------------------------------------
    // Helpers
    // -----------------------------------------------------------------------
    function formatNumber(n) {
      if (n == null) return 'N/A';
      if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
      if (n >= 10000) return (n / 1000).toFixed(0) + 'K';
      if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
      return n.toLocaleString();
    }

    function relativeTime(dateStr) {
      if (!dateStr) return '';
      var diff = Date.now() - new Date(dateStr).getTime();
      var mins = Math.floor(diff / 60000);
      if (mins < 1) return 'just now';
      if (mins < 60) return mins + ' minute' + (mins !== 1 ? 's' : '') + ' ago';
      var hours = Math.floor(mins / 60);
      if (hours < 24) return hours + ' hour' + (hours !== 1 ? 's' : '') + ' ago';
      var days = Math.floor(hours / 24);
      return days + ' day' + (days !== 1 ? 's' : '') + ' ago';
    }

    function daysBetween(d1, d2) {
      var a = new Date(d1);
      var b = new Date(d2);
      return Math.round(Math.abs(b - a) / 86400000);
    }

    function setLoading(status, detail) {
      $loadingStatus.textContent = status;
      $loadingDetail.textContent = detail || '';
    }

    function showError(msg, detail) {
      $loading.style.display = 'none';
      $error.style.display = 'block';
      if (detail) $errorDetail.textContent = detail;
    }

    function makeTimeSeriesOptions(yLabel, yMin, yMax) {
      return {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'nearest', axis: 'x', intersect: false },
        scales: {
          x: {
            type: 'time',
            time: { tooltipFormat: 'MMM d, h:mm a' },
            grid: { color: '#30363d', drawBorder: false },
            ticks: { maxTicksLimit: 8 }
          },
          y: {
            min: yMin,
            max: yMax,
            title: { display: !!yLabel, text: yLabel, color: '#8b949e' },
            grid: { color: '#30363d', drawBorder: false }
          }
        },
        plugins: {
          legend: { display: false }
        },
        elements: {
          point: { radius: 0, hitRadius: 8, hoverRadius: 4 },
          line: { borderWidth: 2, tension: 0.1 }
        }
      };
    }

    // -----------------------------------------------------------------------
    // Data Loading
    // -----------------------------------------------------------------------
    async function loadStats() {
      setLoading('Loading dashboard...', 'Fetching statistics');
      try {
        var resp = await fetch(STATS_URL);
        if (!resp.ok) throw new Error('Stats fetch failed: ' + resp.status);
        stats = await resp.json();
      } catch (e) {
        console.warn('Could not load stats.json:', e);
        stats = null;
      }
    }

    async function loadDatabase() {
      setLoading('Loading dashboard...', 'Downloading telemetry database');
      try {
        var resp = await fetch(DB_URL);
        if (!resp.ok) throw new Error('Database fetch failed: ' + resp.status);

        setLoading('Loading dashboard...', 'Decompressing database');
        var compressed = new Uint8Array(await resp.arrayBuffer());
        var decompressed = pako.inflate(compressed);

        setLoading('Loading dashboard...', 'Initializing SQL engine');
        var SQL = await initSqlJs({
          locateFile: function() { return SQL_WASM_URL; }
        });
        db = new SQL.Database(decompressed);
      } catch (e) {
        console.warn('Could not load database:', e);
        db = null;
      }
    }

    // -----------------------------------------------------------------------
    // Rendering: Stats Cards
    // -----------------------------------------------------------------------
    function renderStats() {
      if (!stats || !stats.lifetime) return;

      var lt = stats.lifetime;

      // Total Records
      document.getElementById('statRecords').textContent = formatNumber(lt.total_records);

      // Days Collecting
      if (lt.date_range && lt.date_range.first_record && lt.date_range.last_record) {
        var days = daysBetween(lt.date_range.first_record, lt.date_range.last_record);
        document.getElementById('statDays').textContent = days.toLocaleString();
      }

      // Unique Signals
      document.getElementById('statSignals').textContent = formatNumber(lt.unique_signals);

      // Lifetime Miles
      if (lt.odometer_miles != null) {
        document.getElementById('statMiles').textContent = lt.odometer_miles.toFixed(1);
      }

      // Last Updated header text
      if (stats.generated_at) {
        $lastUpdated.textContent = 'Last updated: ' + new Date(stats.generated_at).toLocaleString();
      }
    }

    // -----------------------------------------------------------------------
    // Rendering: Coverage Chart
    // -----------------------------------------------------------------------
    function renderCoverageChart() {
      if (!stats || !stats.coverage_trend || stats.coverage_trend.length === 0) {
        document.getElementById('coverageChart').parentElement.innerHTML =
          '<div class="no-data">No coverage data available</div>';
        return;
      }

      var trend = stats.coverage_trend;
      var dates = trend.map(function(d) { return d.date; });

      // Coverage % -- use NaN for null pct so Chart.js draws a gap
      var coveragePct = trend.map(function(d) {
        return d.pct != null ? d.pct : NaN;
      });

      // Sample completeness %
      var samplePct = trend.map(function(d) {
        if (d.observed_samples != null && d.expected_samples != null && d.expected_samples > 0) {
          return (d.observed_samples / d.expected_samples) * 100;
        }
        return NaN;
      });

      // Custom plugin: draw shaded "healthy zone" from 85% to 110%
      var healthyZonePlugin = {
        id: 'healthyZone',
        beforeDraw: function(chart) {
          var ctx = chart.ctx;
          var chartArea = chart.chartArea;
          var yScale = chart.scales.y;
          if (!chartArea) return;
          var top = yScale.getPixelForValue(110);
          var bottom = yScale.getPixelForValue(85);
          ctx.save();
          ctx.fillStyle = 'rgba(63, 185, 80, 0.08)';
          ctx.fillRect(chartArea.left, top, chartArea.width, bottom - top);
          ctx.restore();
        }
      };

      new Chart(document.getElementById('coverageChart'), {
        type: 'line',
        data: {
          labels: dates,
          datasets: [
            {
              label: 'Data Coverage %',
              data: coveragePct,
              borderColor: '#58a6ff',
              backgroundColor: 'rgba(88, 166, 255, 0.1)',
              fill: false,
              spanGaps: false
            },
            {
              label: 'Sample Completeness %',
              data: samplePct,
              borderColor: '#3fb950',
              backgroundColor: 'rgba(63, 185, 80, 0.1)',
              fill: false,
              borderDash: [5, 3],
              spanGaps: false
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          scales: {
            x: {
              type: 'time',
              time: { unit: 'day', tooltipFormat: 'MMM d, yyyy' },
              grid: { color: '#30363d', drawBorder: false },
              ticks: { maxTicksLimit: 14 }
            },
            y: {
              min: 0,
              title: { display: true, text: 'Percentage (%)', color: '#8b949e' },
              grid: { color: '#30363d', drawBorder: false }
            }
          },
          plugins: {
            legend: {
              display: true,
              position: 'top',
              align: 'end'
            },
            tooltip: {
              callbacks: {
                label: function(ctx) {
                  var val = ctx.parsed.y;
                  if (isNaN(val)) return ctx.dataset.label + ': parked (no data)';
                  return ctx.dataset.label + ': ' + val.toFixed(1) + '%';
                }
              }
            }
          },
          elements: {
            point: { radius: 2, hitRadius: 8, hoverRadius: 5 },
            line: { borderWidth: 2, tension: 0.2 }
          }
        },
        plugins: [healthyZonePlugin]
      });
    }

    // -----------------------------------------------------------------------
    // Rendering: Battery Chart
    // -----------------------------------------------------------------------
    function renderBatteryChart() {
      if (!db) {
        document.getElementById('batteryChart').parentElement.innerHTML =
          '<div class="no-data">No database loaded</div>';
        return;
      }

      var rows = db.exec(
        "SELECT created_at, CAST(signal_value AS REAL) FROM telemetry WHERE signal_name = 'BatteryLevel' ORDER BY created_at"
      );

      if (!rows.length || !rows[0].values.length) {
        document.getElementById('batteryChart').parentElement.innerHTML =
          '<div class="no-data">No battery data available</div>';
        return;
      }

      var data = rows[0].values.map(function(r) {
        return { x: new Date(r[0]), y: r[1] };
      });

      new Chart(document.getElementById('batteryChart'), {
        type: 'line',
        data: {
          datasets: [{
            data: data,
            borderColor: '#3fb950',
            backgroundColor: 'rgba(63, 185, 80, 0.1)',
            fill: true
          }]
        },
        options: makeTimeSeriesOptions('%', 0, 100)
      });
    }

    // -----------------------------------------------------------------------
    // Rendering: Speed Chart
    // -----------------------------------------------------------------------
    function renderSpeedChart() {
      if (!db) {
        document.getElementById('speedChart').parentElement.innerHTML =
          '<div class="no-data">No database loaded</div>';
        return;
      }

      var rows = db.exec(
        "SELECT created_at, CAST(signal_value AS REAL) FROM telemetry WHERE signal_name = 'VehicleSpeed' ORDER BY created_at"
      );

      if (!rows.length || !rows[0].values.length) {
        document.getElementById('speedChart').parentElement.innerHTML =
          '<div class="no-data">No speed data available</div>';
        return;
      }

      var data = rows[0].values.map(function(r) {
        return { x: new Date(r[0]), y: r[1] };
      });

      new Chart(document.getElementById('speedChart'), {
        type: 'line',
        data: {
          datasets: [{
            data: data,
            borderColor: '#d29922',
            backgroundColor: 'rgba(210, 153, 34, 0.1)',
            fill: true
          }]
        },
        options: makeTimeSeriesOptions('mph', 0, undefined)
      });
    }

    // -----------------------------------------------------------------------
    // Rendering: Signal Explorer
    // -----------------------------------------------------------------------
    function renderSignalExplorer() {
      if (!db) return;

      var signalRows = db.exec(
        "SELECT DISTINCT signal_name FROM telemetry ORDER BY signal_name"
      );

      if (!signalRows.length || !signalRows[0].values.length) return;

      var signals = signalRows[0].values.map(function(r) { return r[0]; });
      var $select = document.getElementById('signalSelect');
      var $count = document.getElementById('signalCount');

      $count.textContent = signals.length + ' signals available';

      signals.forEach(function(name) {
        var opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        $select.appendChild(opt);
      });

      $select.addEventListener('change', function() {
        loadSignal($select.value);
      });

      // Load the first signal by default
      loadSignal(signals[0]);
    }

    function loadSignal(signalName) {
      var rows = db.exec(
        "SELECT created_at, signal_value FROM telemetry WHERE signal_name = ? ORDER BY created_at",
        [signalName]
      );

      if (!rows.length || !rows[0].values.length) {
        if (explorerChart) { explorerChart.destroy(); explorerChart = null; }
        return;
      }

      var rawData = rows[0].values;

      // Determine if the values are numeric by sampling
      var sampleSize = Math.min(rawData.length, 50);
      var numericCount = 0;
      for (var i = 0; i < sampleSize; i++) {
        var v = parseFloat(rawData[i][1]);
        if (!isNaN(v) && rawData[i][1] !== '' && rawData[i][1] !== null) {
          numericCount++;
        }
      }
      var isNumeric = (numericCount / sampleSize) > 0.8;

      if (explorerChart) {
        explorerChart.destroy();
        explorerChart = null;
      }

      var canvas = document.getElementById('explorerChart');

      if (isNumeric) {
        var data = rawData.map(function(r) {
          return { x: new Date(r[0]), y: parseFloat(r[1]) };
        }).filter(function(d) { return !isNaN(d.y); });

        var opts = makeTimeSeriesOptions(signalName, undefined, undefined);
        opts.plugins = { legend: { display: true, position: 'top', align: 'end' } };

        explorerChart = new Chart(canvas, {
          type: 'line',
          data: {
            datasets: [{
              label: signalName,
              data: data,
              borderColor: '#58a6ff',
              backgroundColor: 'rgba(88, 166, 255, 0.1)',
              fill: true
            }]
          },
          options: opts
        });
      } else {
        // Non-numeric: map unique string values to numeric indices, render stepped
        var uniqueVals = [];
        var seen = {};
        rawData.forEach(function(r) {
          if (!seen[r[1]]) { seen[r[1]] = true; uniqueVals.push(r[1]); }
        });
        uniqueVals.sort();

        var valMap = {};
        uniqueVals.forEach(function(v, i) { valMap[v] = i; });

        var data = rawData.map(function(r) {
          return { x: new Date(r[0]), y: valMap[r[1]] };
        });

        explorerChart = new Chart(canvas, {
          type: 'line',
          data: {
            datasets: [{
              label: signalName,
              data: data,
              borderColor: '#bc8cff',
              backgroundColor: 'rgba(188, 140, 255, 0.1)',
              fill: false,
              stepped: 'before'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'nearest', axis: 'x', intersect: false },
            scales: {
              x: {
                type: 'time',
                time: { tooltipFormat: 'MMM d, h:mm a' },
                grid: { color: '#30363d', drawBorder: false },
                ticks: { maxTicksLimit: 8 }
              },
              y: {
                min: -0.5,
                max: uniqueVals.length - 0.5,
                ticks: {
                  callback: function(val) {
                    return uniqueVals[Math.round(val)] || '';
                  },
                  stepSize: 1
                },
                grid: { color: '#30363d', drawBorder: false }
              }
            },
            plugins: {
              legend: { display: true, position: 'top', align: 'end' },
              tooltip: {
                callbacks: {
                  label: function(ctx) {
                    var v = uniqueVals[Math.round(ctx.parsed.y)];
                    return signalName + ': ' + v;
                  }
                }
              }
            },
            elements: {
              point: { radius: 2, hitRadius: 8, hoverRadius: 5 },
              line: { borderWidth: 2 }
            }
          }
        });
      }
    }

    // -----------------------------------------------------------------------
    // Footer
    // -----------------------------------------------------------------------
    function renderFooter() {
      $footer.style.display = 'block';
      var $updated = document.getElementById('footerUpdated');
      if (stats && stats.generated_at) {
        $updated.textContent = 'Data updated ' + relativeTime(stats.generated_at);
      } else {
        $updated.textContent = '';
      }
    }

    // -----------------------------------------------------------------------
    // Main entry point
    // -----------------------------------------------------------------------
    async function main() {
      try {
        // Load stats first (small, fast)
        await loadStats();

        // Load database (larger)
        await loadDatabase();

        // We need at least one data source to show anything useful
        if (!stats && !db) {
          showError(
            'No data available',
            'Both stats.json and dashboard.db.gz failed to load. The data pipeline may be updating.'
          );
          return;
        }

        // Hide loading, show dashboard
        $loading.style.display = 'none';
        $dashboard.classList.add('visible');

        // Render all panels
        renderStats();
        renderCoverageChart();
        renderBatteryChart();
        renderSpeedChart();
        renderSignalExplorer();
        renderFooter();

      } catch (e) {
        console.error('Dashboard initialization failed:', e);
        showError('Initialization failed', e.message);
      }
    }

    main();
  </script>
</body>
</html>
