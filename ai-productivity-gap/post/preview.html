<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Integral Problem: Why AI Isn't Moving the Productivity Needle</title>
<style>
  :root {
    --bg: #ffffff;
    --text: #333333;
    --text-muted: #666666;
    --link: #2563eb;
    --link-hover: #1d4ed8;
    --code-bg: #f3f4f6;
    --border-muted: rgba(102, 102, 102, 0.2);
  }

  @media (prefers-color-scheme: dark) {
    :root {
      --bg: #1a1a1a;
      --text: #e0e0e0;
      --text-muted: #a0a0a0;
      --link: #60a5fa;
      --link-hover: #93c5fd;
      --code-bg: #2d2d2d;
      --border-muted: rgba(160, 160, 160, 0.2);
    }
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.7;
    font-size: 1.125rem;
  }

  .container {
    max-width: 42rem;
    margin: 0 auto;
    padding: 2rem 1.5rem 4rem;
  }

  header {
    margin-bottom: 2rem;
  }

  header h1 {
    font-size: 1.875rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    line-height: 1.3;
  }

  header time {
    color: var(--text-muted);
    font-size: 0.875rem;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  }

  .prose p {
    margin-bottom: 1.25rem;
  }

  .prose h2 {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 3.5rem 0 1rem;
    padding-top: 2rem;
    border-top: 1px solid var(--border-muted);
    line-height: 1.3;
  }

  .prose h3 {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 2rem 0 0.75rem;
    line-height: 1.3;
  }

  .prose a {
    color: var(--link);
    text-decoration: underline;
  }

  .prose a:hover {
    color: var(--link-hover);
  }

  .prose img {
    max-width: 100%;
    width: 100%;
    height: auto;
    border-radius: 0.5rem;
    margin: 1rem 0;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  @media (prefers-color-scheme: dark) {
    .prose img {
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
    }
  }

  .prose strong {
    font-weight: 600;
  }

  .prose em {
    font-style: italic;
  }

  .prose ul, .prose ol {
    margin-left: 1.5rem;
    margin-bottom: 1.25rem;
  }

  .prose li {
    margin-bottom: 0.35rem;
  }

  .prose blockquote {
    border-left: 3px solid var(--text-muted);
    padding-left: 1.25rem;
    margin: 1.5rem 0;
    font-style: italic;
    font-size: 1.2rem;
    color: var(--text-muted);
  }

  .prose blockquote p {
    margin-bottom: 0;
  }

  .prose hr {
    border: none;
    border-top: 1px solid var(--border-muted);
    margin: 1.5rem 0;
  }

  .prose .caption {
    font-size: 0.85rem;
    color: var(--text-muted);
    font-style: italic;
    margin-top: -0.5rem;
    margin-bottom: 1.25rem;
    line-height: 1.5;
  }

  .tldr-box {
    background: rgba(37, 99, 235, 0.06);
    border: 1px solid rgba(37, 99, 235, 0.15);
    border-radius: 8px;
    padding: 1.25rem 1.5rem;
    margin-bottom: 1.5rem;
  }

  .tldr-box h2 {
    font-size: 1.1rem;
    font-weight: 700;
    margin: 0 0 0.75rem;
    padding-top: 0;
    border-top: none;
    color: var(--text);
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  .tldr-box ul {
    margin-left: 1.25rem;
    margin-bottom: 0;
  }

  .tldr-box li {
    margin-bottom: 0.4rem;
    font-size: 1rem;
  }

  @media (prefers-color-scheme: dark) {
    .tldr-box {
      background: rgba(96, 165, 250, 0.08);
      border-color: rgba(96, 165, 250, 0.2);
    }
  }

  .sources {
    font-size: 0.8rem;
    line-height: 1.5;
    color: var(--text-muted);
  }

  .sources h4 {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-bottom: 0.5rem;
  }

  .sources ul {
    margin-left: 1.2rem;
  }

  .sources li {
    margin-bottom: 0.3rem;
  }

  footer {
    border-top: 1px solid var(--border-muted);
    margin-top: 3rem;
    padding-top: 1.5rem;
    color: var(--text-muted);
    font-size: 0.85rem;
  }

  .draft-banner {
    background: #fef3c7;
    color: #92400e;
    padding: 0.4rem 1rem;
    text-align: center;
    font-size: 0.8rem;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    position: sticky;
    top: 0;
    z-index: 100;
  }

  @media (prefers-color-scheme: dark) {
    .draft-banner {
      background: #422006;
      color: #fef3c7;
    }
  }

  /* -- Commenting system layout -- */

  .page-layout {
    display: flex;
    justify-content: center;
    gap: 0;
    position: relative;
  }

  .container {
    flex: 0 1 42rem;
    min-width: 0;
  }

  .comments-column {
    flex: 0 0 16rem;
    position: relative;
    padding: 2rem 1rem 4rem 0.5rem;
  }

  /* Draft banner buttons */
  .draft-banner {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
  }

  .draft-banner-label {
    font-weight: 600;
    letter-spacing: 0.05em;
  }

  .draft-banner button {
    background: rgba(146, 64, 14, 0.15);
    color: inherit;
    border: 1px solid rgba(146, 64, 14, 0.3);
    padding: 0.15rem 0.6rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-family: inherit;
    cursor: pointer;
    transition: background 0.15s;
  }

  .draft-banner button:hover {
    background: rgba(146, 64, 14, 0.25);
  }

  @media (prefers-color-scheme: dark) {
    .draft-banner button {
      background: rgba(254, 243, 199, 0.1);
      border-color: rgba(254, 243, 199, 0.2);
    }
    .draft-banner button:hover {
      background: rgba(254, 243, 199, 0.2);
    }
  }

  /* Comment highlights in the text */
  mark.comment-highlight {
    background: #fef9c3;
    border-bottom: 2px solid #fde68a;
    border-radius: 2px;
    padding: 0 1px;
    cursor: pointer;
    transition: background 0.15s;
  }

  mark.comment-highlight:hover,
  mark.comment-highlight.active {
    background: #fde68a;
  }

  @media (prefers-color-scheme: dark) {
    mark.comment-highlight {
      background: rgba(254, 249, 195, 0.2);
      border-bottom-color: rgba(253, 230, 138, 0.4);
      color: inherit;
    }
    mark.comment-highlight:hover,
    mark.comment-highlight.active {
      background: rgba(253, 230, 138, 0.35);
    }
  }

  /* Image comment highlights */
  .prose img {
    cursor: pointer;
    transition: outline 0.15s;
  }

  .prose img:hover {
    outline: 2px dashed rgba(245, 158, 11, 0.35);
    outline-offset: 3px;
  }

  .prose img.comment-highlight-img {
    outline: 3px solid #fde68a;
    outline-offset: 3px;
  }

  .prose img.comment-highlight-img:hover,
  .prose img.comment-highlight-img.active {
    outline-color: #f59e0b;
  }

  @media (prefers-color-scheme: dark) {
    .prose img:hover {
      outline-color: rgba(245, 158, 11, 0.25);
    }
    .prose img.comment-highlight-img {
      outline-color: rgba(253, 230, 138, 0.4);
    }
    .prose img.comment-highlight-img:hover,
    .prose img.comment-highlight-img.active {
      outline-color: #f59e0b;
    }
  }

  /* Margin comment cards */
  .comment-card {
    background: #fefce8;
    border: 1px solid #fde68a;
    border-radius: 6px;
    padding: 0.6rem 0.7rem;
    font-size: 0.8rem;
    line-height: 1.45;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
    position: absolute;
    left: 0;
    width: 15rem;
    cursor: pointer;
    transition: border-color 0.15s, box-shadow 0.15s, opacity 0.2s, transform 0.2s;
    opacity: 1;
    transform: translateX(0);
    animation: commentSlideIn 0.2s ease-out;
  }

  @keyframes commentSlideIn {
    from { opacity: 0; transform: translateX(8px); }
    to { opacity: 1; transform: translateX(0); }
  }

  .comment-card:hover {
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
  }

  .comment-card.active {
    border-color: #f59e0b;
    box-shadow: 0 2px 8px rgba(245, 158, 11, 0.2);
  }

  .comment-card-quote {
    font-style: italic;
    color: #92400e;
    margin-bottom: 0.35rem;
    word-break: break-word;
  }

  .comment-card-text {
    color: #333;
    word-break: break-word;
  }

  .comment-card-delete {
    position: absolute;
    top: 4px;
    right: 6px;
    background: none;
    border: none;
    font-size: 0.85rem;
    color: #b45309;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.15s;
    line-height: 1;
    padding: 2px 4px;
  }

  .comment-card:hover .comment-card-delete {
    opacity: 0.6;
  }

  .comment-card-delete:hover {
    opacity: 1 !important;
  }

  @media (prefers-color-scheme: dark) {
    .comment-card {
      background: #292214;
      border-color: rgba(253, 230, 138, 0.3);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }
    .comment-card.active {
      border-color: #f59e0b;
      box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
    }
    .comment-card-quote {
      color: #fcd34d;
    }
    .comment-card-text {
      color: #e0e0e0;
    }
    .comment-card-delete {
      color: #fcd34d;
    }
  }

  /* Floating "Add Comment" button */
  .add-comment-btn {
    position: absolute;
    z-index: 200;
    background: #f59e0b;
    color: #fff;
    border: none;
    padding: 0.3rem 0.75rem;
    border-radius: 999px;
    font-size: 0.78rem;
    font-family: system-ui, -apple-system, sans-serif;
    font-weight: 500;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    white-space: nowrap;
    transition: background 0.15s, transform 0.1s;
    animation: popIn 0.12s ease-out;
  }

  @keyframes popIn {
    from { transform: scale(0.85); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }

  .add-comment-btn:hover {
    background: #d97706;
  }

  /* Floating comment input */
  .comment-input-container {
    position: absolute;
    z-index: 200;
    background: #fefce8;
    border: 1px solid #fde68a;
    border-radius: 8px;
    padding: 0.6rem;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
    width: 18rem;
    animation: popIn 0.12s ease-out;
  }

  .comment-input-container textarea {
    width: 100%;
    border: 1px solid #e5e7eb;
    border-radius: 4px;
    padding: 0.4rem 0.5rem;
    font-size: 0.82rem;
    font-family: inherit;
    line-height: 1.4;
    resize: vertical;
    min-height: 3rem;
    color: #333;
    background: #fff;
  }

  .comment-input-container textarea:focus {
    outline: none;
    border-color: #f59e0b;
    box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.15);
  }

  .comment-input-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.4rem;
    margin-top: 0.4rem;
  }

  .comment-input-actions button {
    padding: 0.25rem 0.6rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-family: inherit;
    cursor: pointer;
    border: none;
  }

  .comment-submit-btn {
    background: #f59e0b;
    color: #fff;
    font-weight: 500;
  }

  .comment-submit-btn:hover {
    background: #d97706;
  }

  .comment-cancel-btn {
    background: #e5e7eb;
    color: #666;
  }

  .comment-cancel-btn:hover {
    background: #d1d5db;
  }

  @media (prefers-color-scheme: dark) {
    .comment-input-container {
      background: #292214;
      border-color: rgba(253, 230, 138, 0.3);
    }
    .comment-input-container textarea {
      background: #1a1a1a;
      color: #e0e0e0;
      border-color: #444;
    }
    .comment-input-container textarea:focus {
      border-color: #f59e0b;
    }
    .comment-cancel-btn {
      background: #444;
      color: #aaa;
    }
  }

  /* Inline comment cards for narrow screens */
  .comment-card-inline {
    background: #fefce8;
    border: 1px solid #fde68a;
    border-radius: 6px;
    padding: 0.5rem 0.65rem;
    font-size: 0.8rem;
    line-height: 1.45;
    margin: 0.5rem 0 1rem 0;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
    position: relative;
    cursor: pointer;
    transition: border-color 0.15s;
  }

  .comment-card-inline.active {
    border-color: #f59e0b;
  }

  .comment-card-inline .comment-card-quote {
    font-style: italic;
    color: #92400e;
    margin-bottom: 0.25rem;
  }

  .comment-card-inline .comment-card-text {
    color: #333;
  }

  .comment-card-inline .comment-card-delete {
    position: absolute;
    top: 4px;
    right: 6px;
    background: none;
    border: none;
    font-size: 0.85rem;
    color: #b45309;
    cursor: pointer;
    opacity: 0.4;
    line-height: 1;
    padding: 2px 4px;
  }

  .comment-card-inline .comment-card-delete:hover {
    opacity: 1;
  }

  @media (prefers-color-scheme: dark) {
    .comment-card-inline {
      background: #292214;
      border-color: rgba(253, 230, 138, 0.3);
    }
    .comment-card-inline.active {
      border-color: #f59e0b;
    }
    .comment-card-inline .comment-card-quote { color: #fcd34d; }
    .comment-card-inline .comment-card-text { color: #e0e0e0; }
    .comment-card-inline .comment-card-delete { color: #fcd34d; }
  }

  /* Wide screen: show margin column, hide inline cards */
  @media (min-width: 900px) {
    .comment-card-inline {
      display: none !important;
    }
  }

  /* Narrow screen: hide margin column, show inline cards */
  @media (max-width: 899px) {
    .comments-column {
      display: none !important;
    }
    .page-layout {
      display: block;
    }
  }
</style>
</head>
<body>

<div class="draft-banner">
  <span class="draft-banner-label">DRAFT PREVIEW</span>
  <button id="save-feedback-btn" title="Export comments as JSON">Save Feedback</button>
  <button id="clear-comments-btn" title="Remove all comments">Clear All Comments</button>
</div>

<div class="page-layout">

<div class="container">

<header>
  <h1>The Integral Problem: Why AI Isn't Moving the Productivity Needle</h1>
  <time>2026-02-21</time>
</header>

<div class="prose">

<div class="tldr-box">
  <h2>TL;DR</h2>
  <ul>
    <li><strong>The problem</strong>: Lab studies show 14-40% individual productivity gains from AI. Aggregate economic impact: 0.01 percentage points. A gap of roughly 1,000x.</li>
    <li><strong>The hypothesis</strong>: AI adoption and potential gain are inversely correlated. The people who would benefit most aren't using the tools; the people using them most need them least.</li>
    <li><strong>What to do</strong>: Mandate the AI path with patience, replace demos with team-specific training, invest in agentic interfaces, and build guardrails instead of gates.</li>
  </ul>
</div>

<hr>

<p>I have deep faith in the ability of deep neural networks and math to improve the human condition but also acknowledge the problem that current AI has its pitfalls (see my writeup on <a href="https://me.bhavanaai.com/blog/the-car-wash-test">the car wash test</a>). I've spent two and a half years testing every major AI model release. Not through demos. By integrating each one into real work: customer communications, data analysis, code generation, product planning.</p>

<p>But in every team I have worked with, at most 1 in 20 engineers had truly adopted AI into their daily workflow. Not just across the company but among core engineering and product teams. Young, tech-savvy people who build software for a living. The people who should have been first. That's not an anecdote. Once I started looking at the research, I found it everywhere.</p>

<p>Last week, Apollo's chief economist Torsten Slok called on a widely circulated article ranking #1 on Hacker News: "AI is everywhere except in the incoming macroeconomic data." He was echoing Robert Solow's 1987 line about computers: "You can see the computer age everywhere but in the productivity statistics."</p>

<blockquote><p><em>GPT-5.2 just derived an original result in theoretical physics. Penn Wharton measured AI's actual aggregate impact at 0.01 percentage points. It seems like the tools work but almost nobody is using them.</em></p></blockquote>

<h2>The mismatch</h2>

<p>In my teams, the engineers who were already the most productive were the ones experimenting with AI. They were writing the cleanest code, holding the strongest mental models. The junior engineers who would have benefited most? They barely touched the tools.</p>

<img src="../charts/01_the_mismatch.png" alt="The Mismatch: AI adoption rate vs. productivity gain by employee percentile">
<p class="caption">Sources: Brynjolfsson, Li &amp; Raymond (2023); Bick, Blandin &amp; Deming (2024)</p>

<p>The research confirms exactly what I saw. Brynjolfsson studied 5,179 customer support agents. Bottom quintile improved 35%. Top quintile? Roughly zero. Bick found a 2:1 education gradient in who actually uses AI. The workers who gain 35% adopt at half the rate of workers who gain close to zero.</p>

<p>Almost perfectly inverted.</p>

<blockquote><p><em>The people standing to gain the most from these tools are the ones who aren't using them, and the people using them the most are the ones who need them least.</em></p></blockquote>

<p>This is the thesis that makes everything else click. It's not just that adoption is low. Adoption and potential gain are inversely correlated.</p>

<h2>The integral problem</h2>

<p>I think about organizational productivity as an integral. The y-axis is each employee's output. The x-axis is their percentile. The total productivity of the organization is the area under that curve.</p>

<img src="../charts/02_the_integral_problem.png" alt="The Integral Problem: realized vs. unrealized productivity gains">
<p class="caption">Sources: Brynjolfsson et al. (2023); BCG-Harvard (2023); Bick et al. (2024)</p>

<p>Look at the chart. The red dashed line is what we'd gain if everyone adopted AI. Huge lifts at the bottom, tapering toward the top. The blue line is what we're actually capturing. Almost nothing. Only the top few percent are using the tools. That red shaded area? All unrealized potential.</p>

<p><em>Realized Gain(x) = Individual Gain(x) x Adoption Rate(x)</em></p>

<p>You're multiplying big numbers by small numbers everywhere. Lab studies find 14-40% individual gains. Penn Wharton measured 0.01 percentage points of aggregate impact. A 1,000x gap. The Anthropic Economic Index found AI usage has a Gini coefficient of 0.84 to 0.86. (That's more concentrated than income inequality in the most unequal country on Earth.)</p>

<h3>Amdahl's Law</h3>

<p>Even among the people who do use AI, the gains disappoint. I spend maybe 10% of my time writing code. (A Microsoft study of 484 developers found the same number.) The rest is meetings, debugging, architecture, code review. All the stuff AI can't touch yet.</p>

<p>If AI makes coding 3x faster, the theoretical maximum improvement is 15%. Even if coding became instant, the max is 25%. That's Amdahl's Law: you can only speed up the fraction of work AI touches.</p>

<p>METR ran the most rigorous test to date. Sixteen experienced developers, randomized to use or not use AI tools on 246 tasks. The AI group was 19% <em>slower</em>. But they believed they'd sped up by 20%.</p>

<h3>The organizational multiplier</h3>

<p>When 1 in 20 on my team used AI effectively, the other 19 still set the pace. Didn't matter that my best engineer wrote code twice as fast if the bottleneck was design review or QA or the deployment pipeline.</p>

<p>This is O-Ring theory. Production is multiplicative. One broken link degrades the whole chain. Google's Project Aristotle confirmed it across 180 teams: how people interact matters more than who's on the team.</p>

<p>Most organizational work isn't breakthrough discovery. It's execution. Delivery. The integral under the full curve determines what ships. Right now, that integral barely moves.</p>

<h2>The capability-adoption gap</h2>

<p>The AI capability curve vs time is practically vertical. The other (organizational productivity) is flat.</p>

<img src="../charts/03_capability_adoption_gap.png" alt="The Capability-Adoption Gap: AI milestones vs. enterprise adoption">
<p class="caption">Source: Compiled from public announcements and benchmark data</p>

<p>Look at this chart. March 2023, GPT-4 passes the bar exam. Late 2024, reasoning models hit PhD levels. Early 2025, autonomous coding agents ship. February 2026, GPT-5.2 contributes original physics.</p>

<p>The capability curve is vertical. Adoption? Flat. Lucidworks found 42% of companies abandoned most AI initiatives in 2025 (up from 17% in 2024). Companies aren't ramping up. They're giving up.</p>

<p>The exceptions prove the rule. Shopify mandated AI as a baseline expectation. JPMorgan went from banning ChatGPT to deploying LLM Suite to 200,000 employees in eight months. The gap isn't between companies that have AI and those that don't. It's between companies that enabled it broadly and those still running pilots.</p>

<h2>Why the gap exists</h2>

<p>I've watched this up close for over two years. Five problems keep surfacing.</p>

<h3>The learning curve is real</h3>

<p>Even for me, getting truly productive with AI took real effort. I got lucky. During paternity leave, I had unstructured time to experiment. I'd hold my son in one arm and voice-transcribe prompts with the other. That gave me something almost no working professional gets: hours of low-stakes experimentation.</p>

<p>Most employees get maybe 30 minutes before the next Slack message. That's not enough. Humlum and Vestergaard confirmed this with 18,000 workers: even when researchers told people AI could halve their task time, it had zero effect on usage. Zero. Information doesn't drive adoption. Friction does.</p>

<h3>The belief deficit</h3>

<p>People's impression of AI comes from two places, both misleading.</p>

<p>Google's AI Overview told users to eat rocks. GPT-5.2 Pro spent nearly three minutes reasoning about whether to walk or drive to the car wash, explicitly noted that "the wash requires the vehicle to be present," and still told me to walk.</p>

<p>Then there's the marketing. Companies spent $8 million per Super Bowl spot. 23% of ads featured AI. Google's Gemini ad hallucinated a fact about Gouda cheese on national television. Only 32% of Americans trust AI. Can you blame them?</p>

<blockquote><p><em>The irony is that the tools that actually work (terminal-based coding agents, agentic workflows) succeed because they target constrained domains where outputs are immediately verifiable. Does the code compile? Does the test pass? But that's not flashy enough for a Super Bowl ad.</em></p></blockquote>

<p>BCG found that leadership support alone swings positive AI sentiment from 15% to 55%. That's a 40-point swing just from managers taking it seriously.</p>

<h3>Corporate training has not evolved</h3>

<p>Every AI training I attended was a marketing person demoing integrations nobody asked for, or an executive showing tools employees aren't allowed to use. The audience nods politely. Nothing changes.</p>

<p>BCG's data: 5+ hours of training gets you to 79% regular usage vs. 67% with less. Twelve percentage points from actually investing. Real training means capstone projects. Each team builds a workflow for their own use case. Not a slide deck. Not a lunch-and-learn.</p>

<h3>Enterprise tools aren't ready</h3>

<p>Companies shove half-baked AI wrappers down employees' throats. "Use our internal chatbot. It's approved by security." You try it. It's slow. The model is two generations behind. You go back to whatever you were doing before.</p>

<p>Meanwhile, the tools that actually work are blocked. So 78% of AI users bring their own tools. JPMorgan figured this out. They went from banning ChatGPT to deploying LLM Suite to 200,000 employees. Solve compliance at the infrastructure level. Build guardrails, not gates.</p>

<h3>Productivity is deeply personal</h3>

<p>The way I write code is different from how you write code. There is no single AI workflow that fits everyone. Enterprise tools pretend otherwise.</p>

<p>The Anthropic Gini data (0.84-0.86) isn't measuring adoption rate. It's measuring how personal productivity is. Power users invested time to build workflows for their specific work. You can't copy-paste that across a thousand people. BCG's "silicon ceiling" data backs this up: frontline adoption stalled at 51% in 2023 and hasn't moved since.</p>

<h2>The agentic interface</h2>

<p>AI is in its pre-browser moment. In the early 1990s, the internet was extraordinary. But using it meant memorizing terminal commands and configuring network settings manually. Then the browser shipped. The technology didn't change. The interface did.</p>

<p>The most powerful AI tooling today lives in the terminal. Claude Code, Codex CLI, Aider. That's structural. CLI tools have full access to your machine: read files, write code, run tests, chain tools together. You can't do that from a chat window.</p>

<p>Two years ago, I ran a customer outreach program at a large tech company. Slow, imprecise, generic messages. Today, with agentic tools, the same campaign can be surgical. Pull data from a CSV. Look up contacts through browser automation. Draft tailored emails. Send through authenticated APIs. All from one interface. But it took real effort to build.</p>

<p>Claude Code crossed $1 billion in annualized revenue faster than ChatGPT. Cursor hit $1 billion ARR. Developers aren't waiting for enterprise tooling. They're building their own workflows now.</p>

<h2>What to do Monday morning</h2>

<h3>Mandate the AI path, with patience</h3>

<p>Default to the AI-assisted approach for new projects. But budget for a temporary productivity dip. You can't mandate AI and penalize people for being slower while they learn.</p>

<h3>Invest in applied training, not demos</h3>

<p>Stop demo-driven training. Each team builds a tool for their own use case, with coaching from AI-fluent colleagues. I became fluent during paternity leave because I had unstructured time. Create that expectation: if it can be done with AI, do it with AI.</p>

<h3>Embrace agentic interfaces</h3>

<p>The productivity unlock isn't the enterprise chat wrapper. It's tools that integrate into real workflows. Pulling data, automating actions, chaining operations. Give teams budget and permission to explore them.</p>

<h3>Accept that productivity is personal</h3>

<p>Stop prescribing one-size-fits-all. Give people time and permission to find their own use cases. The goal is to move the whole distribution rightward, not force everyone through the same door.</p>

<h3>Enable, don't gate</h3>

<p>Stop battling shadow AI. You will lose. If 78% of users bring their own tools, the problem is your approved tools. Solve security at the platform level. Trust your employees.</p>

<h2>The bottom line</h2>

<p>The gap between AI capability and AI impact is organizational, not technological. The mismatch means the people who'd benefit most aren't using the tools. Amdahl's Law means even among those who do, the gains are bounded. The integral barely moves.</p>

<p>Nearly 90% of 6,000 executives in the NBER study said AI has had no impact on productivity. Yet they forecast 1.4% growth over the next three years. The belief is there. The results aren't. That's the Solow paradox, playing out again.</p>

<p>The integral only changes when the whole curve moves. Not just the tail.</p>

</div>

<footer>

<div class="sources">
<h4>Sources</h4>
<ul>
  <li><strong>Productivity gains by skill level:</strong> Brynjolfsson, Li, and Raymond (2023); BCG-Harvard (Dell'Acqua et al., 2023)</li>
  <li><strong>Adoption demographics:</strong> Bick, Blandin, and Deming (2024)</li>
  <li><strong>Usage concentration:</strong> Anthropic, "Economic Index" (September 2025)</li>
  <li><strong>Macro productivity:</strong> Penn Wharton Budget Model; San Francisco Fed</li>
  <li><strong>Organizational theory:</strong> Kremer, "The O-Ring Theory of Economic Development" (1993)</li>
  <li><strong>Team performance:</strong> Google Project Aristotle</li>
  <li><strong>Amdahl's Law:</strong> Amdahl (1967); Microsoft developer time study</li>
  <li><strong>Developer productivity data:</strong> METR RCT (2025)</li>
  <li><strong>Initiative abandonment:</strong> Lucidworks, AI Survey 2025</li>
  <li><strong>Shadow AI:</strong> Industry surveys (2024-2025)</li>
  <li><strong>Training effectiveness:</strong> BCG, "AI at Work" (2024)</li>
  <li><strong>Belief deficit:</strong> BCG leadership support findings (2024); Edelman Trust Barometer</li>
  <li><strong>Company case studies:</strong> Shopify; JPMorgan</li>
  <li><strong>NBER executive survey:</strong> Bick et al. (2025)</li>
  <li><strong>Agentic tools:</strong> Claude Code; Cursor ARR milestones</li>
</ul>
</div>

</footer>

</div>

<div class="comments-column" id="comments-column"></div>

</div>

<script>
(function() {
  'use strict';

  // -- State --
  var STORAGE_KEY = 'draft-comments-' + slugify(document.title);
  var comments = []; // Array of { id, selectedText, comment, section, paragraphContext, charOffset }
  var commentCounter = 0;
  var activeCommentId = null;

  // -- DOM references --
  var prose = document.querySelector('.prose');
  var commentsColumn = document.getElementById('comments-column');
  var saveFeedbackBtn = document.getElementById('save-feedback-btn');
  var clearCommentsBtn = document.getElementById('clear-comments-btn');

  // Floating UI elements (created on demand)
  var addCommentBtn = null;
  var commentInputContainer = null;
  var pendingSelection = null; // text: { type, text, range, rect, paragraph, charOffset, section } or image: { type, text, imgSrc, imgAlt, imgEl, rect, section }

  // -- Utility functions --

  function slugify(str) {
    return str.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
  }

  function generateId() {
    commentCounter++;
    return 'comment-' + Date.now() + '-' + commentCounter;
  }

  function truncate(str, len) {
    if (str.length <= len) return str;
    return str.slice(0, len - 1) + '\u2026';
  }

  function removeAllChildren(el) {
    while (el.firstChild) {
      el.removeChild(el.firstChild);
    }
  }

  function getNearestHeading(node) {
    var el = node.nodeType === 3 ? node.parentElement : node;
    while (el && el !== prose) {
      var prev = el.previousElementSibling;
      while (prev) {
        if (prev.tagName === 'H2' || prev.tagName === 'H3') {
          return prev.textContent.trim();
        }
        prev = prev.previousElementSibling;
      }
      el = el.parentElement;
    }
    return '';
  }

  function getContainingParagraph(node) {
    var el = node.nodeType === 3 ? node.parentElement : node;
    while (el && el !== prose) {
      if (el.tagName === 'P' || el.tagName === 'LI') return el;
      el = el.parentElement;
    }
    return null;
  }

  function getCharOffsetInParagraph(paragraph, range) {
    var walker = document.createTreeWalker(paragraph, NodeFilter.SHOW_TEXT, null, false);
    var offset = 0;
    var node;
    while ((node = walker.nextNode())) {
      if (node === range.startContainer) {
        return offset + range.startOffset;
      }
      offset += node.textContent.length;
    }
    return offset;
  }

  // -- Highlight wrapping --

  function wrapRangeWithMark(range, commentId) {
    var mark = document.createElement('mark');
    mark.className = 'comment-highlight';
    mark.dataset.commentId = commentId;
    try {
      range.surroundContents(mark);
    } catch (e) {
      var fragment = range.extractContents();
      mark.appendChild(fragment);
      range.insertNode(mark);
    }
    mark.addEventListener('click', function() {
      setActiveComment(commentId);
      scrollToCard(commentId);
    });
    return mark;
  }

  function findAndHighlightText(commentData) {
    var paragraphs = prose.querySelectorAll('p, li');
    var targetParagraph = null;
    for (var i = 0; i < paragraphs.length; i++) {
      var pText = paragraphs[i].textContent.slice(0, 100);
      if (pText === commentData.paragraphContext) {
        targetParagraph = paragraphs[i];
        break;
      }
    }
    if (!targetParagraph) return false;

    var fullText = targetParagraph.textContent;
    var searchText = commentData.selectedText;
    var expectedOffset = commentData.charOffset;

    var idx = fullText.indexOf(searchText, Math.max(0, expectedOffset - 5));
    if (idx === -1) {
      idx = fullText.indexOf(searchText);
    }
    if (idx === -1) return false;

    var walker = document.createTreeWalker(targetParagraph, NodeFilter.SHOW_TEXT, null, false);
    var currentOffset = 0;
    var startNode = null, startOff = 0, endNode = null, endOff = 0;
    var node;
    while ((node = walker.nextNode())) {
      var nodeLen = node.textContent.length;
      if (!startNode && currentOffset + nodeLen > idx) {
        startNode = node;
        startOff = idx - currentOffset;
      }
      if (startNode && currentOffset + nodeLen >= idx + searchText.length) {
        endNode = node;
        endOff = idx + searchText.length - currentOffset;
        break;
      }
      currentOffset += nodeLen;
    }

    if (!startNode || !endNode) return false;

    var range = document.createRange();
    range.setStart(startNode, startOff);
    range.setEnd(endNode, endOff);

    wrapRangeWithMark(range, commentData.id);
    return true;
  }

  function removeHighlight(commentId) {
    var marks = prose.querySelectorAll('mark[data-comment-id="' + commentId + '"]');
    marks.forEach(function(mark) {
      var parent = mark.parentNode;
      while (mark.firstChild) {
        parent.insertBefore(mark.firstChild, mark);
      }
      parent.removeChild(mark);
      parent.normalize();
    });
  }

  // -- Image comment helpers --

  function getImageForComment(commentData) {
    var imgs = prose.querySelectorAll('img');
    for (var i = 0; i < imgs.length; i++) {
      if (imgs[i].getAttribute('src') === commentData.imgSrc) return imgs[i];
    }
    return null;
  }

  function addImageHighlight(img, commentId) {
    img.classList.add('comment-highlight-img');
    var ids = (img.dataset.commentIds || '').split(' ').filter(Boolean);
    if (ids.indexOf(commentId) === -1) ids.push(commentId);
    img.dataset.commentIds = ids.join(' ');
    img.addEventListener('click', onImageClick);
  }

  function removeImageHighlight(img, commentId) {
    var ids = (img.dataset.commentIds || '').split(' ').filter(Boolean);
    ids = ids.filter(function(id) { return id !== commentId; });
    if (ids.length === 0) {
      img.classList.remove('comment-highlight-img');
      img.classList.remove('active');
      delete img.dataset.commentIds;
    } else {
      img.dataset.commentIds = ids.join(' ');
    }
  }

  function getAnchorForComment(commentData) {
    if (commentData.type === 'image') {
      return getImageForComment(commentData);
    }
    return prose.querySelector('mark[data-comment-id="' + commentData.id + '"]');
  }

  // -- Comment cards --

  function renderAllCards() {
    removeAllChildren(commentsColumn);

    var inlineCards = prose.querySelectorAll('.comment-card-inline');
    for (var i = 0; i < inlineCards.length; i++) {
      inlineCards[i].remove();
    }

    for (var j = 0; j < comments.length; j++) {
      createMarginCard(comments[j]);
      createInlineCard(comments[j]);
    }

    positionMarginCards();
  }

  function createMarginCard(commentData) {
    var card = document.createElement('div');
    card.className = 'comment-card';
    if (commentData.id === activeCommentId) card.classList.add('active');
    card.dataset.commentId = commentData.id;

    var quote = document.createElement('div');
    quote.className = 'comment-card-quote';
    if (commentData.type === 'image') {
      quote.textContent = 'Chart: ' + truncate(commentData.imgAlt || commentData.imgSrc, 50);
    } else {
      quote.textContent = '\u201c' + truncate(commentData.selectedText, 50) + '\u201d';
    }

    var text = document.createElement('div');
    text.className = 'comment-card-text';
    text.textContent = commentData.comment;

    var del = document.createElement('button');
    del.className = 'comment-card-delete';
    del.textContent = '\u00d7';
    del.title = 'Delete comment';
    del.addEventListener('click', function(e) {
      e.stopPropagation();
      deleteComment(commentData.id);
    });

    card.appendChild(quote);
    card.appendChild(text);
    card.appendChild(del);

    card.addEventListener('click', function() {
      setActiveComment(commentData.id);
      scrollToHighlight(commentData.id);
    });

    commentsColumn.appendChild(card);
  }

  function createInlineCard(commentData) {
    var anchor = getAnchorForComment(commentData);
    if (!anchor) return;

    var card = document.createElement('div');
    card.className = 'comment-card-inline';
    if (commentData.id === activeCommentId) card.classList.add('active');
    card.dataset.commentId = commentData.id;

    var quote = document.createElement('div');
    quote.className = 'comment-card-quote';
    if (commentData.type === 'image') {
      quote.textContent = 'Chart: ' + truncate(commentData.imgAlt || commentData.imgSrc, 50);
    } else {
      quote.textContent = '\u201c' + truncate(commentData.selectedText, 50) + '\u201d';
    }

    var text = document.createElement('div');
    text.className = 'comment-card-text';
    text.textContent = commentData.comment;

    var del = document.createElement('button');
    del.className = 'comment-card-delete';
    del.textContent = '\u00d7';
    del.title = 'Delete comment';
    del.addEventListener('click', function(e) {
      e.stopPropagation();
      deleteComment(commentData.id);
    });

    card.appendChild(quote);
    card.appendChild(text);
    card.appendChild(del);

    card.addEventListener('click', function() {
      setActiveComment(commentData.id);
      scrollToHighlight(commentData.id);
    });

    var parent = commentData.type === 'image' ? anchor : anchor.closest('p, li, h2, h3, img');
    if (parent && parent.parentNode) {
      parent.parentNode.insertBefore(card, parent.nextSibling);
    }
  }

  function positionMarginCards() {
    var cards = commentsColumn.querySelectorAll('.comment-card');
    var scrollY = window.scrollY || document.documentElement.scrollTop;
    var columnTop = commentsColumn.getBoundingClientRect().top + scrollY;
    var lastBottom = 0;

    for (var i = 0; i < cards.length; i++) {
      var card = cards[i];
      var commentId = card.dataset.commentId;
      var commentData = comments.find(function(c) { return c.id === commentId; });
      var anchor = commentData ? getAnchorForComment(commentData) : null;
      if (!anchor) {
        // Fallback: try mark element directly
        anchor = prose.querySelector('mark[data-comment-id="' + commentId + '"]');
      }
      if (!anchor) continue;

      var anchorRect = anchor.getBoundingClientRect();
      var desiredTop = anchorRect.top + scrollY - columnTop;

      if (desiredTop < lastBottom + 8) {
        desiredTop = lastBottom + 8;
      }

      card.style.top = desiredTop + 'px';
      lastBottom = desiredTop + card.offsetHeight;
    }
  }

  // -- Active comment highlighting --

  function setActiveComment(commentId) {
    activeCommentId = commentId;

    var highlights = prose.querySelectorAll('mark.comment-highlight');
    for (var i = 0; i < highlights.length; i++) {
      highlights[i].classList.toggle('active', highlights[i].dataset.commentId === commentId);
    }

    // Toggle active state on commented images
    var commentedImgs = prose.querySelectorAll('img.comment-highlight-img');
    for (var m = 0; m < commentedImgs.length; m++) {
      var imgIds = (commentedImgs[m].dataset.commentIds || '').split(' ');
      commentedImgs[m].classList.toggle('active', imgIds.indexOf(commentId) !== -1);
    }

    var marginCards = commentsColumn.querySelectorAll('.comment-card');
    for (var j = 0; j < marginCards.length; j++) {
      marginCards[j].classList.toggle('active', marginCards[j].dataset.commentId === commentId);
    }

    var inlineCards = prose.querySelectorAll('.comment-card-inline');
    for (var k = 0; k < inlineCards.length; k++) {
      inlineCards[k].classList.toggle('active', inlineCards[k].dataset.commentId === commentId);
    }
  }

  function scrollToCard(commentId) {
    var isWide = window.innerWidth >= 900;
    var card;
    if (isWide) {
      card = commentsColumn.querySelector('.comment-card[data-comment-id="' + commentId + '"]');
    } else {
      card = prose.querySelector('.comment-card-inline[data-comment-id="' + commentId + '"]');
    }
    if (card) {
      card.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }

  function scrollToHighlight(commentId) {
    var commentData = comments.find(function(c) { return c.id === commentId; });
    var anchor = commentData ? getAnchorForComment(commentData) : null;
    if (!anchor) {
      anchor = prose.querySelector('mark[data-comment-id="' + commentId + '"]');
    }
    if (anchor) {
      anchor.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }

  // -- Floating "Add Comment" button --

  function showAddCommentButton(x, y) {
    removeAddCommentButton();
    addCommentBtn = document.createElement('button');
    addCommentBtn.className = 'add-comment-btn';
    addCommentBtn.textContent = 'Comment';
    addCommentBtn.style.left = x + 'px';
    addCommentBtn.style.top = y + 'px';
    document.body.appendChild(addCommentBtn);

    addCommentBtn.addEventListener('mousedown', function(e) {
      e.preventDefault();
      e.stopPropagation();
    });
    addCommentBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      showCommentInput();
    });
  }

  function removeAddCommentButton() {
    if (addCommentBtn && addCommentBtn.parentNode) {
      addCommentBtn.parentNode.removeChild(addCommentBtn);
    }
    addCommentBtn = null;
  }

  // -- Comment input --

  function showCommentInput() {
    removeAddCommentButton();
    removeCommentInput();
    if (!pendingSelection) return;

    commentInputContainer = document.createElement('div');
    commentInputContainer.className = 'comment-input-container';

    var textarea = document.createElement('textarea');
    textarea.placeholder = 'Add your comment\u2026';
    textarea.rows = 2;

    var actions = document.createElement('div');
    actions.className = 'comment-input-actions';

    var cancelBtn = document.createElement('button');
    cancelBtn.className = 'comment-cancel-btn';
    cancelBtn.textContent = 'Cancel';

    var submitBtn = document.createElement('button');
    submitBtn.className = 'comment-submit-btn';
    submitBtn.textContent = 'Add';

    actions.appendChild(cancelBtn);
    actions.appendChild(submitBtn);

    commentInputContainer.appendChild(textarea);
    commentInputContainer.appendChild(actions);

    var scrollY = window.scrollY || document.documentElement.scrollTop;
    var scrollX = window.scrollX || document.documentElement.scrollLeft;
    var rect = pendingSelection.rect;
    var left = rect.right + scrollX + 8;
    var top = rect.top + scrollY;

    if (left + 288 > window.innerWidth + scrollX) {
      left = rect.left + scrollX - 296;
    }
    if (left < scrollX + 8) {
      left = scrollX + 8;
    }

    commentInputContainer.style.left = left + 'px';
    commentInputContainer.style.top = top + 'px';
    document.body.appendChild(commentInputContainer);
    textarea.focus();

    submitBtn.addEventListener('click', function() {
      submitComment(textarea.value.trim());
    });

    cancelBtn.addEventListener('click', function() {
      removeCommentInput();
      pendingSelection = null;
    });

    textarea.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        submitComment(textarea.value.trim());
      }
      if (e.key === 'Escape') {
        removeCommentInput();
        pendingSelection = null;
      }
    });
  }

  function removeCommentInput() {
    if (commentInputContainer && commentInputContainer.parentNode) {
      commentInputContainer.parentNode.removeChild(commentInputContainer);
    }
    commentInputContainer = null;
  }

  function submitComment(text) {
    if (!text || !pendingSelection) {
      removeCommentInput();
      pendingSelection = null;
      return;
    }

    var id = generateId();
    var commentData;

    if (pendingSelection.type === 'image') {
      commentData = {
        id: id,
        type: 'image',
        selectedText: pendingSelection.imgAlt || pendingSelection.imgSrc,
        comment: text,
        section: pendingSelection.section,
        imgSrc: pendingSelection.imgSrc,
        imgAlt: pendingSelection.imgAlt
      };
      addImageHighlight(pendingSelection.imgEl, id);
    } else {
      commentData = {
        id: id,
        type: 'text',
        selectedText: pendingSelection.text,
        comment: text,
        section: pendingSelection.section,
        paragraphContext: pendingSelection.paragraphContext,
        charOffset: pendingSelection.charOffset
      };
      try {
        var sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(pendingSelection.range);
        wrapRangeWithMark(pendingSelection.range, id);
      } catch(e) {
        findAndHighlightText(commentData);
      }
    }

    comments.push(commentData);
    saveToLocalStorage();
    removeCommentInput();
    pendingSelection = null;

    renderAllCards();
    setActiveComment(id);

    requestAnimationFrame(function() { positionMarginCards(); });
  }

  // -- Delete comment --

  function deleteComment(commentId) {
    var commentData = comments.find(function(c) { return c.id === commentId; });
    if (commentData && commentData.type === 'image') {
      var img = getImageForComment(commentData);
      if (img) removeImageHighlight(img, commentId);
    } else {
      removeHighlight(commentId);
    }
    comments = comments.filter(function(c) { return c.id !== commentId; });
    if (activeCommentId === commentId) activeCommentId = null;
    saveToLocalStorage();
    renderAllCards();
  }

  // -- Persistence --

  function saveToLocalStorage() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(comments));
    } catch(e) { /* silently fail */ }
  }

  function loadFromLocalStorage() {
    try {
      var stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        comments = JSON.parse(stored);
        for (var i = 0; i < comments.length; i++) {
          var parts = comments[i].id.split('-');
          var num = parseInt(parts[parts.length - 1], 10);
          if (num > commentCounter) commentCounter = num;
        }
      }
    } catch(e) {
      comments = [];
    }
  }

  function restoreComments() {
    loadFromLocalStorage();
    for (var i = 0; i < comments.length; i++) {
      if (comments[i].type === 'image') {
        var img = getImageForComment(comments[i]);
        if (img) addImageHighlight(img, comments[i].id);
      } else {
        findAndHighlightText(comments[i]);
      }
    }
    renderAllCards();
  }

  // -- Save feedback to file --

  function saveFeedback() {
    var exportData = {
      draft: document.title,
      timestamp: new Date().toISOString(),
      comments: comments.map(function(c) {
        var out = {
          id: c.id,
          type: c.type || 'text',
          selectedText: c.selectedText,
          comment: c.comment,
          section: c.section
        };
        if (c.type === 'image') {
          out.imgSrc = c.imgSrc;
          out.imgAlt = c.imgAlt;
        } else {
          out.paragraphContext = c.paragraphContext;
        }
        return out;
      })
    };

    var json = JSON.stringify(exportData, null, 2);

    if (window.showSaveFilePicker) {
      window.showSaveFilePicker({
        suggestedName: 'feedback.json',
        types: [{
          description: 'JSON files',
          accept: { 'application/json': ['.json'] }
        }]
      }).then(function(handle) {
        return handle.createWritable().then(function(writable) {
          return writable.write(json).then(function() {
            return writable.close();
          });
        });
      }).catch(function(e) {
        if (e.name === 'AbortError') return;
        downloadFallback(json);
      });
    } else {
      downloadFallback(json);
    }
  }

  function downloadFallback(json) {
    var blob = new Blob([json], { type: 'application/json' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'feedback.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // -- Clear all comments --

  function clearAllComments() {
    if (comments.length === 0) return;
    if (!confirm('Remove all comments? This cannot be undone.')) return;

    for (var i = 0; i < comments.length; i++) {
      if (comments[i].type === 'image') {
        var img = getImageForComment(comments[i]);
        if (img) removeImageHighlight(img, comments[i].id);
      } else {
        removeHighlight(comments[i].id);
      }
    }
    comments = [];
    activeCommentId = null;
    saveToLocalStorage();
    renderAllCards();
  }

  // -- Selection handling --

  function handleMouseUp(e) {
    if (e.target.closest('.add-comment-btn, .comment-input-container, .comment-card, .comment-card-inline, .draft-banner')) {
      return;
    }

    // Skip text selection handling when clicking on images (handled by onImageClick)
    if (e.target.tagName === 'IMG' && e.target.closest('.prose')) {
      return;
    }

    if (commentInputContainer && !e.target.closest('.comment-input-container')) {
      removeCommentInput();
      pendingSelection = null;
    }

    var sel = window.getSelection();
    if (!sel || sel.isCollapsed || !sel.rangeCount) {
      removeAddCommentButton();
      return;
    }

    var range = sel.getRangeAt(0);
    var text = sel.toString().trim();
    if (!text) {
      removeAddCommentButton();
      return;
    }

    var container = range.commonAncestorContainer;
    var inProse = (container.nodeType === 3 ? container.parentElement : container).closest('.prose');
    if (!inProse) {
      removeAddCommentButton();
      return;
    }

    var startInMark = range.startContainer.nodeType === 3
      ? range.startContainer.parentElement.closest('mark.comment-highlight')
      : range.startContainer.closest ? range.startContainer.closest('mark.comment-highlight') : null;
    if (startInMark) {
      removeAddCommentButton();
      return;
    }

    var paragraph = getContainingParagraph(range.startContainer);
    var paragraphContext = paragraph ? paragraph.textContent.slice(0, 100) : '';
    var charOffset = paragraph ? getCharOffsetInParagraph(paragraph, range) : 0;
    var section = getNearestHeading(range.startContainer);

    pendingSelection = {
      text: text,
      range: range.cloneRange(),
      rect: range.getBoundingClientRect(),
      paragraph: paragraph,
      paragraphContext: paragraphContext,
      charOffset: charOffset,
      section: section
    };

    var scrollY = window.scrollY || document.documentElement.scrollTop;
    var scrollX = window.scrollX || document.documentElement.scrollLeft;
    var rect = range.getBoundingClientRect();
    var btnX = rect.right + scrollX + 4;
    var btnY = rect.top + scrollY - 32;

    if (btnX + 80 > window.innerWidth + scrollX) {
      btnX = rect.left + scrollX;
    }
    if (btnY < scrollY) {
      btnY = rect.bottom + scrollY + 4;
    }

    showAddCommentButton(btnX, btnY);
  }

  function onImageClick(e) {
    var img = e.target;
    if (!img || img.tagName !== 'IMG' || !img.closest('.prose')) return;

    // If there's an open comment input, close it
    removeAddCommentButton();
    removeCommentInput();

    var section = getNearestHeading(img);
    var rect = img.getBoundingClientRect();

    pendingSelection = {
      type: 'image',
      text: img.alt || img.src,
      imgSrc: img.getAttribute('src'),
      imgAlt: img.getAttribute('alt') || '',
      imgEl: img,
      rect: rect,
      section: section
    };

    var scrollY = window.scrollY || document.documentElement.scrollTop;
    var scrollX = window.scrollX || document.documentElement.scrollLeft;
    var btnX = rect.right + scrollX - 80;
    var btnY = rect.top + scrollY + 8;

    showAddCommentButton(btnX, btnY);
    e.stopPropagation();
  }

  function handleClick(e) {
    if (e.target.closest('.comment-card, .comment-card-inline, mark.comment-highlight, .add-comment-btn, .comment-input-container') || (e.target.tagName === 'IMG' && e.target.closest('.prose'))) {
      return;
    }
    if (activeCommentId) {
      setActiveComment(null);
    }
  }

  function handleResizeOrScroll() {
    positionMarginCards();
  }

  // -- Wire up events --

  document.addEventListener('mouseup', handleMouseUp);
  document.addEventListener('click', handleClick);
  window.addEventListener('resize', handleResizeOrScroll);
  window.addEventListener('scroll', handleResizeOrScroll);

  saveFeedbackBtn.addEventListener('click', saveFeedback);
  clearCommentsBtn.addEventListener('click', clearAllComments);

  // -- Initialize --

  // Attach click handlers to all images in prose
  var proseImages = prose.querySelectorAll('img');
  for (var ii = 0; ii < proseImages.length; ii++) {
    proseImages[ii].addEventListener('click', onImageClick);
  }

  restoreComments();

  window.addEventListener('load', function() {
    positionMarginCards();
  });
})();
</script>

</body>
</html>