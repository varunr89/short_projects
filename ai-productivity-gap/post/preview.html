<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Integral Problem: Why AI Isn't Moving the Productivity Needle</title>
<style>
  :root {
    --bg: #ffffff;
    --text: #333333;
    --text-muted: #666666;
    --link: #2563eb;
    --link-hover: #1d4ed8;
    --code-bg: #f3f4f6;
    --border-muted: rgba(102, 102, 102, 0.2);
  }

  @media (prefers-color-scheme: dark) {
    :root {
      --bg: #1a1a1a;
      --text: #e0e0e0;
      --text-muted: #a0a0a0;
      --link: #60a5fa;
      --link-hover: #93c5fd;
      --code-bg: #2d2d2d;
      --border-muted: rgba(160, 160, 160, 0.2);
    }
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.7;
    font-size: 1.125rem;
  }

  .container {
    max-width: 42rem;
    margin: 0 auto;
    padding: 2rem 1.5rem 4rem;
  }

  header {
    margin-bottom: 2rem;
  }

  header h1 {
    font-size: 1.875rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    line-height: 1.3;
  }

  header time {
    color: var(--text-muted);
    font-size: 0.875rem;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  }

  .prose p {
    margin-bottom: 1.25rem;
  }

  .prose h2 {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 2.5rem 0 1rem;
    line-height: 1.3;
  }

  .prose h3 {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 2rem 0 0.75rem;
    line-height: 1.3;
  }

  .prose a {
    color: var(--link);
    text-decoration: underline;
  }

  .prose a:hover {
    color: var(--link-hover);
  }

  .prose img {
    max-width: 100%;
    width: 100%;
    height: auto;
    border-radius: 0.5rem;
    margin: 1rem 0;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  @media (prefers-color-scheme: dark) {
    .prose img {
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
    }
  }

  .prose strong {
    font-weight: 600;
  }

  .prose em {
    font-style: italic;
  }

  .prose ul, .prose ol {
    margin-left: 1.5rem;
    margin-bottom: 1.25rem;
  }

  .prose li {
    margin-bottom: 0.35rem;
  }

  .prose blockquote {
    border-left: 3px solid var(--text-muted);
    padding-left: 1.25rem;
    margin: 1.5rem 0;
    font-style: italic;
    font-size: 1.2rem;
    color: var(--text-muted);
  }

  .prose blockquote p {
    margin-bottom: 0;
  }

  .prose hr {
    border: none;
    border-top: 1px solid var(--border-muted);
    margin: 1.5rem 0;
  }

  .prose .caption {
    font-size: 0.85rem;
    color: var(--text-muted);
    font-style: italic;
    margin-top: -0.5rem;
    margin-bottom: 1.25rem;
    line-height: 1.5;
  }

  .tldr-box {
    background: rgba(37, 99, 235, 0.06);
    border: 1px solid rgba(37, 99, 235, 0.15);
    border-radius: 8px;
    padding: 1.25rem 1.5rem;
    margin-bottom: 1.5rem;
  }

  .tldr-box h2 {
    font-size: 1.1rem;
    font-weight: 700;
    margin: 0 0 0.75rem;
    color: var(--text);
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  .tldr-box ul {
    margin-left: 1.25rem;
    margin-bottom: 0;
  }

  .tldr-box li {
    margin-bottom: 0.4rem;
    font-size: 1rem;
  }

  @media (prefers-color-scheme: dark) {
    .tldr-box {
      background: rgba(96, 165, 250, 0.08);
      border-color: rgba(96, 165, 250, 0.2);
    }
  }

  .sources {
    font-size: 0.8rem;
    line-height: 1.5;
    color: var(--text-muted);
  }

  .sources h4 {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-bottom: 0.5rem;
  }

  .sources ul {
    margin-left: 1.2rem;
  }

  .sources li {
    margin-bottom: 0.3rem;
  }

  footer {
    border-top: 1px solid var(--border-muted);
    margin-top: 3rem;
    padding-top: 1.5rem;
    color: var(--text-muted);
    font-size: 0.85rem;
  }

  .draft-banner {
    background: #fef3c7;
    color: #92400e;
    padding: 0.4rem 1rem;
    text-align: center;
    font-size: 0.8rem;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    position: sticky;
    top: 0;
    z-index: 100;
  }

  @media (prefers-color-scheme: dark) {
    .draft-banner {
      background: #422006;
      color: #fef3c7;
    }
  }

  /* -- Commenting system layout -- */

  .page-layout {
    display: flex;
    justify-content: center;
    gap: 0;
    position: relative;
  }

  .container {
    flex: 0 1 42rem;
    min-width: 0;
  }

  .comments-column {
    flex: 0 0 16rem;
    position: relative;
    padding: 2rem 1rem 4rem 0.5rem;
  }

  /* Draft banner buttons */
  .draft-banner {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
  }

  .draft-banner-label {
    font-weight: 600;
    letter-spacing: 0.05em;
  }

  .draft-banner button {
    background: rgba(146, 64, 14, 0.15);
    color: inherit;
    border: 1px solid rgba(146, 64, 14, 0.3);
    padding: 0.15rem 0.6rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-family: inherit;
    cursor: pointer;
    transition: background 0.15s;
  }

  .draft-banner button:hover {
    background: rgba(146, 64, 14, 0.25);
  }

  @media (prefers-color-scheme: dark) {
    .draft-banner button {
      background: rgba(254, 243, 199, 0.1);
      border-color: rgba(254, 243, 199, 0.2);
    }
    .draft-banner button:hover {
      background: rgba(254, 243, 199, 0.2);
    }
  }

  /* Comment highlights in the text */
  mark.comment-highlight {
    background: #fef9c3;
    border-bottom: 2px solid #fde68a;
    border-radius: 2px;
    padding: 0 1px;
    cursor: pointer;
    transition: background 0.15s;
  }

  mark.comment-highlight:hover,
  mark.comment-highlight.active {
    background: #fde68a;
  }

  @media (prefers-color-scheme: dark) {
    mark.comment-highlight {
      background: rgba(254, 249, 195, 0.2);
      border-bottom-color: rgba(253, 230, 138, 0.4);
      color: inherit;
    }
    mark.comment-highlight:hover,
    mark.comment-highlight.active {
      background: rgba(253, 230, 138, 0.35);
    }
  }

  /* Image comment highlights */
  .prose img {
    cursor: pointer;
    transition: outline 0.15s;
  }

  .prose img:hover {
    outline: 2px dashed rgba(245, 158, 11, 0.35);
    outline-offset: 3px;
  }

  .prose img.comment-highlight-img {
    outline: 3px solid #fde68a;
    outline-offset: 3px;
  }

  .prose img.comment-highlight-img:hover,
  .prose img.comment-highlight-img.active {
    outline-color: #f59e0b;
  }

  @media (prefers-color-scheme: dark) {
    .prose img:hover {
      outline-color: rgba(245, 158, 11, 0.25);
    }
    .prose img.comment-highlight-img {
      outline-color: rgba(253, 230, 138, 0.4);
    }
    .prose img.comment-highlight-img:hover,
    .prose img.comment-highlight-img.active {
      outline-color: #f59e0b;
    }
  }

  /* Margin comment cards */
  .comment-card {
    background: #fefce8;
    border: 1px solid #fde68a;
    border-radius: 6px;
    padding: 0.6rem 0.7rem;
    font-size: 0.8rem;
    line-height: 1.45;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
    position: absolute;
    left: 0;
    width: 15rem;
    cursor: pointer;
    transition: border-color 0.15s, box-shadow 0.15s, opacity 0.2s, transform 0.2s;
    opacity: 1;
    transform: translateX(0);
    animation: commentSlideIn 0.2s ease-out;
  }

  @keyframes commentSlideIn {
    from { opacity: 0; transform: translateX(8px); }
    to { opacity: 1; transform: translateX(0); }
  }

  .comment-card:hover {
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
  }

  .comment-card.active {
    border-color: #f59e0b;
    box-shadow: 0 2px 8px rgba(245, 158, 11, 0.2);
  }

  .comment-card-quote {
    font-style: italic;
    color: #92400e;
    margin-bottom: 0.35rem;
    word-break: break-word;
  }

  .comment-card-text {
    color: #333;
    word-break: break-word;
  }

  .comment-card-delete {
    position: absolute;
    top: 4px;
    right: 6px;
    background: none;
    border: none;
    font-size: 0.85rem;
    color: #b45309;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.15s;
    line-height: 1;
    padding: 2px 4px;
  }

  .comment-card:hover .comment-card-delete {
    opacity: 0.6;
  }

  .comment-card-delete:hover {
    opacity: 1 !important;
  }

  @media (prefers-color-scheme: dark) {
    .comment-card {
      background: #292214;
      border-color: rgba(253, 230, 138, 0.3);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }
    .comment-card.active {
      border-color: #f59e0b;
      box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
    }
    .comment-card-quote {
      color: #fcd34d;
    }
    .comment-card-text {
      color: #e0e0e0;
    }
    .comment-card-delete {
      color: #fcd34d;
    }
  }

  /* Floating "Add Comment" button */
  .add-comment-btn {
    position: absolute;
    z-index: 200;
    background: #f59e0b;
    color: #fff;
    border: none;
    padding: 0.3rem 0.75rem;
    border-radius: 999px;
    font-size: 0.78rem;
    font-family: system-ui, -apple-system, sans-serif;
    font-weight: 500;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    white-space: nowrap;
    transition: background 0.15s, transform 0.1s;
    animation: popIn 0.12s ease-out;
  }

  @keyframes popIn {
    from { transform: scale(0.85); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }

  .add-comment-btn:hover {
    background: #d97706;
  }

  /* Floating comment input */
  .comment-input-container {
    position: absolute;
    z-index: 200;
    background: #fefce8;
    border: 1px solid #fde68a;
    border-radius: 8px;
    padding: 0.6rem;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
    width: 18rem;
    animation: popIn 0.12s ease-out;
  }

  .comment-input-container textarea {
    width: 100%;
    border: 1px solid #e5e7eb;
    border-radius: 4px;
    padding: 0.4rem 0.5rem;
    font-size: 0.82rem;
    font-family: inherit;
    line-height: 1.4;
    resize: vertical;
    min-height: 3rem;
    color: #333;
    background: #fff;
  }

  .comment-input-container textarea:focus {
    outline: none;
    border-color: #f59e0b;
    box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.15);
  }

  .comment-input-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.4rem;
    margin-top: 0.4rem;
  }

  .comment-input-actions button {
    padding: 0.25rem 0.6rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-family: inherit;
    cursor: pointer;
    border: none;
  }

  .comment-submit-btn {
    background: #f59e0b;
    color: #fff;
    font-weight: 500;
  }

  .comment-submit-btn:hover {
    background: #d97706;
  }

  .comment-cancel-btn {
    background: #e5e7eb;
    color: #666;
  }

  .comment-cancel-btn:hover {
    background: #d1d5db;
  }

  @media (prefers-color-scheme: dark) {
    .comment-input-container {
      background: #292214;
      border-color: rgba(253, 230, 138, 0.3);
    }
    .comment-input-container textarea {
      background: #1a1a1a;
      color: #e0e0e0;
      border-color: #444;
    }
    .comment-input-container textarea:focus {
      border-color: #f59e0b;
    }
    .comment-cancel-btn {
      background: #444;
      color: #aaa;
    }
  }

  /* Inline comment cards for narrow screens */
  .comment-card-inline {
    background: #fefce8;
    border: 1px solid #fde68a;
    border-radius: 6px;
    padding: 0.5rem 0.65rem;
    font-size: 0.8rem;
    line-height: 1.45;
    margin: 0.5rem 0 1rem 0;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
    position: relative;
    cursor: pointer;
    transition: border-color 0.15s;
  }

  .comment-card-inline.active {
    border-color: #f59e0b;
  }

  .comment-card-inline .comment-card-quote {
    font-style: italic;
    color: #92400e;
    margin-bottom: 0.25rem;
  }

  .comment-card-inline .comment-card-text {
    color: #333;
  }

  .comment-card-inline .comment-card-delete {
    position: absolute;
    top: 4px;
    right: 6px;
    background: none;
    border: none;
    font-size: 0.85rem;
    color: #b45309;
    cursor: pointer;
    opacity: 0.4;
    line-height: 1;
    padding: 2px 4px;
  }

  .comment-card-inline .comment-card-delete:hover {
    opacity: 1;
  }

  @media (prefers-color-scheme: dark) {
    .comment-card-inline {
      background: #292214;
      border-color: rgba(253, 230, 138, 0.3);
    }
    .comment-card-inline.active {
      border-color: #f59e0b;
    }
    .comment-card-inline .comment-card-quote { color: #fcd34d; }
    .comment-card-inline .comment-card-text { color: #e0e0e0; }
    .comment-card-inline .comment-card-delete { color: #fcd34d; }
  }

  /* Wide screen: show margin column, hide inline cards */
  @media (min-width: 900px) {
    .comment-card-inline {
      display: none !important;
    }
  }

  /* Narrow screen: hide margin column, show inline cards */
  @media (max-width: 899px) {
    .comments-column {
      display: none !important;
    }
    .page-layout {
      display: block;
    }
  }
</style>
</head>
<body>

<div class="draft-banner">
  <span class="draft-banner-label">DRAFT PREVIEW</span>
  <button id="save-feedback-btn" title="Export comments as JSON">Save Feedback</button>
  <button id="clear-comments-btn" title="Remove all comments">Clear All Comments</button>
</div>

<div class="page-layout">

<div class="container">

<header>
  <h1>The Integral Problem: Why AI Isn't Moving the Productivity Needle</h1>
  <time>2026-02-19</time>
</header>

<div class="prose">

<div class="tldr-box">
  <h2>TL;DR</h2>
  <ul>
    <li><strong>The problem</strong>: Lab studies consistently show 14-40% individual productivity gains from AI. But aggregate economic impact is 0.01 percentage points. The gap is roughly 1,000x.</li>
    <li><strong>The hypothesis</strong>: AI adoption and potential gain are inversely correlated. The people who would benefit most from these tools are the least likely to use them, and the people using them most are the ones who need them least.</li>
    <li><strong>What to do Monday morning</strong>: Mandate the AI path (with patience), replace demo training with team-specific capstone projects, invest in agentic interfaces, accept that productivity is personal, and enable with guardrails instead of gates.</li>
  </ul>
</div>

<hr>

<p>Last week, GPT-5.2 derived an original result in theoretical physics -- a formula that physicists had assumed was zero for decades, co-authored with researchers from the Institute for Advanced Study, Cambridge, and Harvard through a 12-hour scaffolded reasoning session. Three years earlier, GPT-4 could barely count the R's in "strawberry."</p>

<p>That's the capability trajectory. Here's the productivity trajectory: Penn Wharton measured AI's actual impact on aggregate total factor productivity and found 0.01 percentage points. The Kansas City Fed confirmed that while AI adoption correlates with industry-level productivity growth, "it explains little of the shift in aggregate contributions." The San Francisco Fed explicitly invoked Robert Solow's 1987 observation -- "you can see the computer age everywhere but in the productivity statistics" -- and concluded it remains relevant today.</p>

<p>One curve is practically vertical. The other is flat.</p>

<p>I've spent the last two and a half years working across engineering and product teams at a large tech company, and in that time I've personally evaluated every major AI model release -- not through chat and demos but by integrating each one into my actual work. Customer communications, data analysis, code generation, product planning. I subscribe to every frontier AI service and evaluate them end-to-end on real tasks.</p>

<p>The progression in AI models has been staggering. In early 2023, GPT-4 passed the bar exam at the 90th percentile. By mid-2024, models could see images and hold real-time voice conversations. By late 2024, they could autonomously control a computer desktop. By early 2025, reasoning models performed at PhD levels on science benchmarks. We went from models that wrote passable haikus to autonomous agents contributing genuine scientific discoveries, in under three years.</p>

<p>And yet. In every team I worked with, at most 1 in 20 engineers had truly adopted AI into their daily workflow. Not 1 in 20 across the whole company. Not 1 in 20 among random employees. One in twenty among core engineering and product teams at a major technology company -- young, tech-savvy people who build software for a living. The people who should have been first.</p>

<p>That ratio is not an anecdote. It's empirical evidence. And once I started looking at the research, I found it everywhere.</p>

<h2>The mismatch</h2>

<p>Here's what makes this story more painful than a simple "people aren't adopting new technology" narrative.</p>

<img src="../charts/01_the_mismatch.png" alt="The Mismatch: AI adoption rate vs. productivity gain by employee percentile">
<p class="caption"><em>Sources: Brynjolfsson, Li &amp; Raymond (2023); BCG/Harvard (Dell'Acqua et al., 2023); Bick, Blandin &amp; Deming (2024); Pew Research (2024)</em></p>

<p>The people who would gain the most from AI are the least likely to use the tools.</p>

<p>Brynjolfsson, Li, and Raymond studied 5,179 customer support agents at a Fortune 500 company and found that AI increased overall productivity by 14%. But the gains were wildly uneven. The bottom quintile -- the lowest-performing 20% of agents -- improved by 35%. The top quintile improved by roughly zero. The mechanism was straightforward: the AI had essentially encoded the knowledge and patterns of top performers and redistributed them downward.</p>

<p>Dell'Acqua and colleagues at Harvard ran a controlled study with 758 BCG consultants -- 7% of the firm's entire consulting force -- using GPT-4. Below-average consultants improved output quality by 43%. Above-average consultants improved by 17%. The performance gap between the top and bottom performers shrank from 22 percentage points to just 4.</p>

<p>The pattern is remarkably consistent across studies: AI is an equalizer. It lifts the floor far more than it raises the ceiling.</p>

<p>Now look at who actually uses it. Bick, Blandin, and Deming ran the first nationally representative U.S. survey on generative AI use and found a stark 2:1 education gradient -- about 40% of college-educated workers use AI at work, compared to about 20% of workers without a college degree. Pew Research confirmed the gap is widening, from 7 percentage points to 12 in a single year. Humlum and Vestergaard surveyed 18,000 Danish workers and found that higher-earning workers adopt at significantly higher rates, even controlling for experience and tenure.</p>

<p>I saw this play out in my own teams. The engineers who were already the most productive -- the ones writing the cleanest code, the ones who already had strong mental models of the codebase -- were the ones experimenting with AI. The junior engineers, the ones ramping up on new systems, the ones who would have benefited most from an AI that could explain unfamiliar code or suggest patterns they hadn't learned yet? They barely touched the tools.</p>

<p>The mismatch is almost perfectly inverted. The workers who gain 35-43% from AI adopt at half the rate of workers who gain 0-17%.</p>

<blockquote><p><em>The people standing to gain the most from these tools are the ones who aren't using them, and the people using them the most are the ones who need them least.</em></p></blockquote>

<p>This is the thesis that makes everything else in this post click. It's not just that adoption is low. It's that adoption and potential gain are inversely correlated.</p>

<h2>The integral problem</h2>

<p>If I visualize organizational productivity, the y-axis is the output of each employee and the x-axis is the employee percentile. The total productivity of the organization is the area under that curve -- the integral.</p>

<p>A note on scope: I'm talking about productivity here, not revenue. An organization can be extremely productive and still be in the wrong market. AI today is overwhelmingly focused on making people better at what they already do -- speeding up existing tasks, not identifying new work or new markets. That transformation is coming, but it's not here yet.</p>

<img src="../charts/02_the_integral_problem.png" alt="The Integral Problem: realized vs. unrealized productivity gains">
<p class="caption"><em>Sources: Brynjolfsson et al. (2023); Bick et al. (2024); Penn Wharton Budget Model (2025)</em></p>

<p>The realized gain at any point on the distribution equals the individual gain multiplied by the adoption rate:</p>

<p><em>Realized Gain(x) = Individual Gain(x) x Adoption Rate(x)</em></p>

<p>Both factors work against us. At the bottom of the distribution, where individual gains are highest (35-43% per Brynjolfsson and the BCG study), adoption rates are lowest (around 20% per Bick, Blandin, and Deming). At the top, where adoption rates are highest (40-50%), individual gains are smallest (0-17%). You're multiplying big numbers by small numbers everywhere.</p>

<p>The result shows up in the macro data. Lab studies consistently find 14-40% productivity gains for specific tasks. Penn Wharton measured 0.01 percentage points of actual impact on aggregate total factor productivity. That's a gap of roughly 1,000x.</p>

<blockquote><p><em>"It's not electricity, it's not refrigeration -- it's not that transformative." -- Kent Smetters, Penn Wharton Budget Model</em></p></blockquote>

<p>The Anthropic Economic Index measured AI usage patterns across enterprise deployments and found a Gini coefficient of 0.84 to 0.86. If you lined up every employee in an organization by how much they use AI, the distribution would look like a hockey stick lying on its back. A tiny cluster of power users at the far end accounts for almost all the usage. A Gini of 0.85 is more concentrated than income inequality in the most unequal country on Earth. <em>Frontier workers in their dataset sent 6x more messages than the median enterprise user.</em></p>

<h3>Amdahl's law</h3>

<p>But the mismatch only explains part of the gap. Even among the people who do use AI, the gains don't translate as expected. Here's why.</p>

<p>Amdahl's Law, formulated in 1967, states that the overall speedup of a system is limited by the fraction of the task that cannot be improved:</p>

<p><em>Speedup = 1 / ((1 - p) + p/s)</em></p>

<p>Where <em>p</em> is the fraction of work that AI accelerates and <em>s</em> is the speedup factor.</p>

<p>A Microsoft study of 484 developers found they spend only about 11% of their time actually writing code. The rest goes to meetings (12%), debugging (9%), architecture and design (6%), code review (5%), and everything else. Even the most generous estimates (Tidelift's survey of 400 developers) put coding at 32% of time.</p>

<p>Run the math. If coding is 20% of a developer's time and AI makes it 3x faster, the theoretical maximum improvement is 15%. If coding is 11% (Microsoft's data), even a 10x speedup yields only 11% overall. And even if AI made coding infinitely fast -- instant, zero time -- the maximum possible improvement would be 25%, because the other 75-80% of the work isn't coding.</p>

<p>The data confirms this isn't just theory. Faros AI studied 10,000+ developers across 1,255 teams and found that high AI adopters merged 98% more pull requests. But PR review time increased 91%, PR size grew 154%, and bugs increased 9% per developer. At the company level, they found "no significant correlation between AI adoption and improvements." GitHub's Octoverse data tells the same story: 29% more merged pull requests in 2025, but no corresponding improvement in delivery metrics.</p>

<p>The most striking finding comes from METR's randomized controlled trial -- the most rigorous study to date. Sixteen experienced open-source developers, averaging 5 years of experience on their specific repositories, were randomized to use or not use AI tools on 246 tasks. The result: developers using AI were 19% <em>slower</em>. But here's the kicker -- they believed AI had sped them up by 20%. A perception gap of nearly 40 percentage points.</p>

<p>GitClear's analysis of 211 million lines of code found that refactoring collapsed from 24.1% to 9.5% of all changes while code duplication rose 48%. More code is being written. Less of it is being written well. As the DORA Report 2025 put it: "AI doesn't fix a team; it amplifies what's already there."</p>

<h3>The organizational multiplier</h3>

<p>Michael Kremer's O-Ring theory -- named after the Challenger disaster, where a single faulty component destroyed the entire shuttle -- models production as a multiplicative function. If any one person in the chain fails at their task, they destroy a disproportionate fraction of the product's value. Applied to AI: when only 1 in 20 team members uses AI effectively, the other 19 still set the pace. The quality chain breaks at every link that hasn't been upgraded. It doesn't matter that your best engineer writes code twice as fast if the bottleneck is the design review, the QA process, or the deployment pipeline.</p>

<p>Google's Project Aristotle study of 180 internal teams found that "who is on a team matters less than how the team members interact." Psychological safety -- not individual brilliance -- was the single strongest predictor of team performance. The AI parallel is direct: having one AI power user on a team of twenty is like having one superstar on a team that can't communicate. The individual's output is constrained by the system around them.</p>

<p>I want to be honest about the counterargument. O'Boyle and Aguinis showed convincingly that individual performance in knowledge work follows a power-law distribution, not a normal one. Stars are real. Netflix's "talent density" philosophy explicitly embraces this: in creative work, the best performers may be 10x better than their peers.</p>

<p>But even under a power-law distribution, the body of the distribution produces the majority of total output. Price's Law says half of all output comes from the square root of contributors -- but the other half comes from everyone else. If you have 1,000 engineers and 50 are exceptional, those 50 contribute enormously per capita. But the other 950 still produce the majority of aggregate work. Remove them and you've halved your total output.</p>

<p>Most organizational work is not a breakthrough discovery or a transformative deal. It's execution. Delivery. Operations. The kind of work where the aggregate matters, where the integral under the full curve determines what ships and what doesn't. And right now, the mismatch and Amdahl's Law are working in concert to ensure that integral barely moves.</p>

<h2>The capability-adoption gap</h2>

<p>The timeline makes the absurdity visible.</p>

<img src="../charts/03_capability_adoption_gap.png" alt="The Capability-Adoption Gap: AI milestones vs. enterprise adoption">
<p class="caption"><em>Source: Compiled from public announcements and benchmark data</em></p>

<p>In March 2023, GPT-4 passed the bar exam at the 90th percentile. Six months later, models could understand images. By May 2024, GPT-4o held real-time multimodal conversations with 320-millisecond response times. By September 2024, OpenAI's o1 performed at PhD levels on physics and chemistry. In October 2024, AI won a Nobel Prize. By early 2025, autonomous coding agents shipped -- Claude Code, Codex CLI, GitHub Copilot's agent mode. By late 2025, AI coding tools achieved 77% on the SWE-bench benchmark. By February 2026, GPT-5.2 contributed original theoretical physics.</p>

<p>The capability curve is practically vertical. The adoption curve stays stubbornly flat.</p>

<p>According to Lucidworks, 42% of companies abandoned most of their AI initiatives in 2025, up from 17% in 2024. Companies aren't ramping up. They're giving up. McKinsey reported that over $1 trillion was spent on IT last year, yet more than 60% of companies reported no significant bottom-line impact from AI. Gartner officially placed generative AI in the "Trough of Disillusionment" in 2025.</p>

<p>Meanwhile, a handful of companies are seeing massive returns. Anthropic's internal survey found employees use Claude in 59% of their daily work, with a 50% average productivity boost -- and 27% of Claude-assisted tasks wouldn't have been done at all without AI. Shopify mandated AI as a baseline expectation and saw non-engineering teams become their fastest-growing AI users. JPMorgan went from banning ChatGPT in February 2023 to deploying LLM Suite to 200,000 employees within eight months, winning American Banker's Innovation of the Year.</p>

<p>The gap isn't between companies that have AI and companies that don't. It's between companies that enabled it broadly and companies that are still running pilots.</p>

<h2>Why the gap exists</h2>

<p>I've watched this play out up close for over two years. Five problems keep surfacing.</p>

<h3>The learning curve is real</h3>

<p>I consider myself AI-fluent. I've been building with these tools since GPT-3. And even for me, getting truly productive with AI required significant effort.</p>

<p>I got lucky. During paternity leave, I had unstructured time to experiment. I'd hold my son in one arm and voice-transcribe prompts with the other. That sounds absurd, but it gave me something almost no working professional gets: hours of low-stakes experimentation. Trying things, failing, adjusting, building intuition. That's what it actually takes.</p>

<p>Most employees don't have that. They have meetings, deadlines, and sprint commitments. They get maybe 30 minutes to try a new tool before the next Slack message pulls them away. That's not enough to build fluency. It's barely enough to get through setup.</p>

<p>Humlum and Vestergaard found something that should alarm every manager trying to drive adoption. In their study of 18,000 Danish workers, even when researchers randomly informed workers that AI could halve their task time, it had no effect on usage behavior. None. Information alone doesn't drive adoption. Knowing the tool is powerful doesn't make people use it. The frictions -- lack of time, lack of training, lack of integration into existing workflows -- are causal barriers, not just correlates.</p>

<p>This is not an awareness problem. It's a friction problem.</p>

<h3>The belief deficit</h3>

<p>People's impression of AI is shaped by two forces, both misleading.</p>

<p>On one side: high-profile failures. Google's AI Overview told users to put glue on pizza and eat rocks -- sourcing a decade-old Reddit joke and a satirical Onion article, then re-learning the glue recommendation from news coverage of its own mistake. GPT-5.2 Pro spent 2 minutes and 45 seconds reasoning through the "car wash test" -- should I walk or drive to the car wash? -- explicitly noted in its chain of thought that "the wash requires the vehicle to be present," and then still concluded the user should walk. Multiple frontier models couldn't count the R's in "strawberry" or correctly compare 9.11 and 9.9. Air Canada was held legally liable when its chatbot gave wrong bereavement fare information. A lawyer was fined $5,000 for citing six AI-fabricated court cases; by 2025, researchers tracked 486 similar cases worldwide.</p>

<p>On the other side: aspirational marketing divorced from reality. Companies spent roughly $8 million per 30-second spot during the 2026 Super Bowl, where 23% of all ads featured AI. Google ran a Gemini ad during the 2025 Super Bowl that hallucinated a false fact about Gouda cheese on national television. Microsoft's 2024 Copilot Super Bowl ad promised AI would "help you fulfill your dreams" -- but by early 2026, only 3.3% of Microsoft 365 seats had paid for Copilot. The reception of AI ads at the 2026 Super Bowl was "sharply negative," with Adweek writing that it "revealed AI's messaging crisis."</p>

<p>The result: only 32% of Americans express trust in AI (Edelman). Only 5% say they "trust AI a lot" (YouGov). 49% reject growing AI use entirely.</p>

<p>Can you blame someone for not wanting to stake their reputation on a tool they associate with eating rocks on one end and unfulfilled marketing promises on the other?</p>

<p>The irony is that the real AI innovation -- the tools that actually work -- is happening in places most people never see. Terminal-based coding agents, autonomous research tools, agentic workflows that chain together dozens of operations. These succeed precisely because they target constrained domains where outputs can be immediately verified. Does the code compile? Does the test pass? But they aren't flashy enough for a Super Bowl ad.</p>

<p>The belief deficit is fixable. BCG found that positive sentiment toward AI jumps from 15% to 55% when employees receive strong leadership support. That's a 40-percentage-point swing driven entirely by whether leadership signals that AI is a serious, supported initiative rather than a fad. Only about 25% of frontline employees currently report having that level of support.</p>

<p>The fix isn't a newsletter or an all-hands deck. It's managers actively using AI in their own work, showing real output from their own domain, and holding teams to quality standards that demonstrate AI-assisted work done well is good work -- not suspected work. One of the reasons coding is the furthest along in AI adoption is that code is testable. You get immediate feedback: it compiles or it doesn't, the test passes or it doesn't. Most knowledge work isn't testable in that way. That's where human managers come in -- providing the feedback loops and quality gates that quality control requires.</p>

<h3>Corporate training has not evolved</h3>

<p>Every AI training I attended was a marketing person who didn't understand the problems employees actually work on, demoing integrations nobody asked for -- or an executive showing off tools that employees aren't even allowed to use.</p>

<p>The demos show someone using ChatGPT to conduct customer research, build a document, or create a presentation. The audience nods politely. Then everyone goes back to their desks and nothing changes. Not because the demos were wrong, but because they were completely disconnected from the ways people actually work. Nobody walked away understanding how the tool would help them maintain the same quality and attention to detail as their existing workflow. They saw what's theoretically possible in a vacuum. They didn't see how it fits.</p>

<p>AI training at most organizations means showing people Copilot or ChatGPT. But that's a narrow definition. Not all work can be done through a chat interface, and AI training cannot be one-size-fits-all -- it must be specific to the work each team actually does.</p>

<p>BCG's numbers tell the story. Among regular AI users, 18% received no training at all. Among those who did get training, only 36% said it was enough. But here's the lever: employees who received 5 or more hours of training became regular AI users at a rate of 79%, compared to 67% for those with less. Twelve percentage points of adoption driven by the difference between serious training and token training.</p>

<p>Real training looks like capstone projects, not lunch-and-learns. Each team builds a tool or workflow for their specific use case, with coaching and mentoring along the way. A sales team builds automated prospect research. A support team builds a knowledge base query tool. An engineering team builds a code review assistant. The output is something they actually use the next week. One size does not fit all.</p>

<h3>Enterprise tools aren't ready</h3>

<p>Companies love to shove their own half-baked AI wrappers down employees' throats. "Use our internal copilot. It's approved by security." The internal copilot is a thin wrapper around a rate-limited API with a clunky interface and a model that's two generations behind.</p>

<p>Meanwhile, the tools that actually work -- Claude Code, Cursor, GitHub Copilot -- are either blocked or exist in a gray area. So what happens? Shadow AI. Employees use the good tools anyway, just on their personal machines, outside the security perimeter.</p>

<p>Microsoft's own Work Trend Index found that 78% of AI users bring their own AI tools to work. At small and medium businesses, that number rises to 80%. Gartner found that 69% of organizations suspect employees are using prohibited AI tools. And 48% of employees say they wouldn't stop even if banned.</p>

<p>This isn't just a productivity failure. It's a security risk. IBM's 2025 Cost of a Data Breach report found that organizations with high shadow AI usage paid $670,000 more per breach. Shadow AI incidents account for 20% of all data breaches. When almost four out of five people bypass your approved tools, the problem is the approved tools.</p>

<blockquote><p><em>The countries that over-regulate AI development slow down. The same dynamic plays out inside organizations. When you make it hard to use AI, people either don't use it or use it outside your visibility. Neither outcome is what you want.</em></p></blockquote>

<p>Samsung banned ChatGPT in May 2023 after engineers pasted proprietary code into it. They built internal tools, restricted everything, and eventually reversed course -- reinstating access under new security protocols. JPMorgan banned it the same month, then spent a year building LLM Suite, and now has 125,000+ daily active users. The pattern repeats: ban, realize banning doesn't work, build secure infrastructure, enable broadly.</p>

<h3>Productivity is deeply personal</h3>

<p>Knowledge work is individual. The way I write code is different from how you write code. The way I draft documents, run analyses, manage projects -- all different. There is no single AI workflow that fits everyone.</p>

<p>Enterprise tools are designed as if one workflow works for all. It doesn't. A product manager needs AI for different things than a backend engineer, who needs it for different things than a data scientist, who needs it for different things than a marketing lead.</p>

<p>The Anthropic Gini data (0.84-0.86 concentration) isn't just measuring adoption rate. It's measuring the deeply personal nature of productivity. The power users aren't power users because they got a better demo. They're power users because they invested the time to build workflows that fit their specific work.</p>

<p>BCG's data on the "silicon ceiling" drives this home. Frontline worker adoption stalled at 51% in 2023 and hasn't moved since, despite two years of capability improvements and organizational push. The ceiling isn't a capability ceiling. It's a personalization ceiling. The tools haven't met these workers where they are.</p>

<h2>The agentic interface</h2>

<p>There's a useful analogy that keeps coming to mind. By the early 1990s, the internet's underlying capability was extraordinary -- email, file transfer, hyperlinked documents spanning the globe. But using it meant memorizing terminal commands, understanding protocols, configuring network settings manually. The capability existed, but it was locked behind an interface that excluded almost everyone.</p>

<p>Then the browser shipped. The technology didn't change. The interface did. And that interface change turned the internet from an academic tool into the defining infrastructure of modern life.</p>

<p>AI is in its pre-browser moment right now. The capability is remarkable, real, and accelerating. But the dominant interfaces constrain what's possible.</p>

<p>At the top of the power curve, you have CLI tools -- Claude Code, Codex CLI, Aider. These live in your terminal and give AI direct access to the tools you already use. They're maximally powerful. Claude Code crossed $1 billion in annualized revenue faster than ChatGPT reached that milestone.</p>

<p>The reason the most powerful AI tooling lives in the terminal isn't incidental -- it's structural. CLI tools have full access to the capabilities of your machine. They can read files, write code, run tests, automate email through local APIs, chain tools together, and enforce quality-control strategies like version control and automated testing. You can't do this from a separate GUI where your only option is to copy and paste between windows. Copy-pasting is the enemy of quality.</p>

<p>Here's a concrete example of what becomes possible when the interface gets out of the way. Two years ago, I drove a customer communication program reaching out to hundreds of customers at a large tech company. It was slow, imprecise, and mostly ineffective -- generic messages and hoping they landed. Using agentic AI tools today, the same type of campaign can be surgical: pulling local data from a CSV, looking up contacts through browser automation, drafting tailored emails with specific actions based on usage patterns, sending through authenticated APIs, filling out forms automatically. All from a single interface.</p>

<p>But it wasn't easy. It took trial and error. Not just prompt iteration -- most of the time went into finding ways to string together tools at scale. Building custom pipelines, handling edge cases, iterating on output quality. The effort pays off, but you have to invest it. The enterprise chat wrappers that promise "AI in a box" can't deliver this level of integration.</p>

<p>One layer down from CLI, IDE integrations like Cursor and GitHub Copilot bring agent capabilities into developers' editors. An emerging middle layer -- TUIs like OpenCode (100K+ GitHub stars, 650K monthly active users in five months) -- provides the terminal with visual affordances, bridging power and accessibility.</p>

<blockquote><p><em>And at the bottom of the agentic spectrum, enterprise chat wrappers like Microsoft Copilot and Google Gemini for Workspace. These are roughly where web search was before the browser: the answers exist, but the interface makes it tedious to find them.</em></p></blockquote>

<p>The investment signal is unmistakable. Claude Code at $1 billion ARR. Cursor at $1 billion ARR. OpenCode at 100K+ stars in months. Developers aren't waiting for enterprise tooling to catch up. They're building their own agentic workflows now.</p>

<p>The call to action is simple: invest in agentic interfaces, not just chat wrappers. The browser didn't just make the internet easier to use. It made entirely new categories of work possible. Agentic AI interfaces will do the same, if we stop treating chat wrappers as the end state.</p>

<h2>What to do Monday morning</h2>

<p>I've laid out the problem. Here's what I'd actually do about it, starting this week.</p>

<h3>Mandate the AI path, with patience</h3>

<p>For new projects, default to the AI-assisted approach. Don't make it optional. But hold quality to the same bar as before. The goal is not to ship faster. The goal is to ship the same quality, faster, once people are up to speed.</p>

<p>Here's the part most managers skip: you have to budget for a temporary productivity dip. You cannot mandate AI and then penalize people for being slower while they learn. That kills adoption dead. Humlum's research showed that even knowing about AI's benefits doesn't change behavior when friction is high. You have to actively reduce the friction, which means time and patience.</p>

<blockquote><p><em>AI without review is like shipping code without tests.</em></p></blockquote>

<p>John Ousterhout from Stanford calls AI a "tactical tornado." It lets you move fast, but speed without review produces slop. The fix is active review and tight feedback loops, not pulling back from AI.</p>

<h3>Invest in applied training, not demos</h3>

<p>Stop doing demo-driven AI training. Today. It's worse than useless because it creates the illusion that you've invested in adoption.</p>

<p>BCG's data makes the case. Employees with 5 or more hours of training use AI regularly at a rate of 79%. Those with less: 67%. That 12-point gap is the difference between a team where AI is part of the workflow and a team where it's a novelty.</p>

<p>Real training means capstone projects, not slide decks:</p>
<ul>
  <li>Each team builds a tool or workflow for their own use case, divided by work group</li>
  <li>Mentoring and coaching from AI-fluent colleagues throughout</li>
  <li>A supportive environment where AI is the default approach -- even when it's initially slower</li>
  <li>Follow-up sessions to share what worked and what didn't</li>
</ul>

<p>I became fluent during paternity leave because I had unstructured time. You can't give everyone paternity leave, but you can create the expectation that if a problem can be solved manually or with AI, choose the AI route. The long-term gains compound. The patience pays off.</p>

<h3>Embrace agentic interfaces</h3>

<p>The real productivity unlock is not the enterprise chat wrapper your company deployed last quarter. It's the agentic tools that integrate into real workflows -- tools that can pull data from your systems, automate routine actions, chain together multi-step operations, and iterate on failures without you managing every step.</p>

<p>I know this is a harder sell than "just add AI to Outlook." But the data is clear: the tools growing fastest -- Claude Code, Cursor, OpenCode -- are the ones that give users genuine agency, not just an autocomplete box in a sidebar.</p>

<p>Give teams the budget and the permission to explore agentic tools. Solve for security at the platform level so you can say "yes" to the tools that actually work. Shopify's approach is instructive: they bought thousands of Cursor licenses, built internal MCP servers connecting every data system, and had their legal team default to "yes, how can we do this safely?" instead of blocking.</p>

<h3>Accept that productivity is personal</h3>

<p>Stop prescribing. There is no one-size-fits-all AI workflow. A mandate to "use tool X for task Y" will fail because it ignores how individual knowledge work actually is.</p>

<p>The Anthropic Gini coefficient of 0.84-0.86 is not just a measure of inequality. It's a measure of how personal AI productivity is. The power users found workflows that fit their specific work. You can't copy-paste that across a thousand people.</p>

<p>Instead: give people time and explicit permission to find their own use cases. Celebrate when someone discovers an unconventional workflow. Share wins across teams. Let adoption be organic, messy, and personal. The goal is to move the whole distribution rightward, not to force everyone through the same door.</p>

<h3>Enable, don't gate</h3>

<p>Stop battling shadow AI. You will lose.</p>

<p>If 78% of AI users are bringing their own tools to work, that tells you something fundamental about your approved tools. If 69% of organizations already have evidence of shadow AI, banning is not just ineffective -- it's expensive. IBM found shadow AI accounts for 20% of all data breaches, at an average cost $670,000 higher per incident.</p>

<p>The companies that figured this out are winning. JPMorgan went from banning ChatGPT to deploying LLM Suite to 200,000 employees, solving for compliance at the infrastructure level. Shopify made AI usage a performance expectation and removed all token quotas. The pattern is consistent: solve for security at the platform level, then open the gates.</p>

<p>Trust your employees. Build guardrails, not gates. There's a meaningful difference. The companies that win will be the ones that figured out how to say "yes, and here's how to do it safely" instead of "no."</p>

<h2>The bottom line</h2>

<p>The gap between AI capability and AI impact is not a technology problem. It's an organizational one, compounded by a mathematical one.</p>

<p>The mismatch means the people who would benefit most aren't using the tools. Amdahl's Law means that even among those who do, speeding up one part of the workflow just moves the bottleneck. The integral barely moves because both forces work in concert: adoption is concentrated where gains are smallest, and even those gains are bounded by the parts of the work that AI doesn't touch.</p>

<p>The research consistently shows 14-40% productivity gains in controlled settings. The economy shows 0.01 percentage points. That 1,000x gap isn't going to close with better models. It's going to close when organizations stop treating AI as a tool for their most advanced employees and start treating it as infrastructure for everyone.</p>

<p>The integral only changes when the whole curve moves. Not just the tail.</p>

</div>

<footer>

<div class="sources">
<h4>Sources</h4>
<ul>
  <li><strong>Productivity gains by skill level:</strong> Brynjolfsson, Li, and Raymond (2023); Dell'Acqua et al. (2023); Noy and Zhang (2023)</li>
  <li><strong>Adoption demographics:</strong> Bick, Blandin, and Deming (2024); Pew Research (2024-2025); Humlum and Vestergaard (2024)</li>
  <li><strong>AI adoption:</strong> McKinsey, "The State of AI" (2024, 2025)</li>
  <li><strong>Employee-level usage:</strong> Worklytics, "2025 AI Adoption Benchmarks"</li>
  <li><strong>Usage concentration:</strong> Anthropic, "Economic Index" (September 2025)</li>
  <li><strong>Macro productivity:</strong> Penn Wharton Budget Model; Kansas City Fed (2026); San Francisco Fed</li>
  <li><strong>Organizational theory:</strong> Kremer, "The O-Ring Theory of Economic Development" (1993); Steiner, "Group Process and Productivity" (1972)</li>
  <li><strong>Team performance:</strong> Woolley et al. (2010); Google Project Aristotle</li>
  <li><strong>Individual performance distribution:</strong> O'Boyle and Aguinis (2012)</li>
  <li><strong>Amdahl's Law:</strong> Amdahl (1967); Microsoft developer time study; Tidelift survey</li>
  <li><strong>Developer productivity data:</strong> Faros AI (2025); GitHub Octoverse (2025); METR RCT (2025); GitClear (2025); DORA Report (2025)</li>
  <li><strong>Initiative abandonment:</strong> Lucidworks, AI Survey 2025; Gartner Hype Cycle (2025)</li>
  <li><strong>Shadow AI:</strong> Microsoft Work Trend Index (2024); Gartner (2025); IBM Cost of a Data Breach (2025)</li>
  <li><strong>Training effectiveness:</strong> BCG, "AI at Work" (2024); OECD AI training report</li>
  <li><strong>Belief deficit:</strong> BCG leadership support findings (2024); Edelman Trust Barometer; YouGov</li>
  <li><strong>Company case studies:</strong> Anthropic internal survey; Shopify; JPMorgan; Samsung</li>
  <li><strong>Agentic tools:</strong> Semi Analysis; UC San Diego/Cornell developer survey (2026)</li>
</ul>
</div>

</footer>

</div>

<div class="comments-column" id="comments-column"></div>

</div>

<script>
(function() {
  'use strict';

  // -- State --
  var STORAGE_KEY = 'draft-comments-' + slugify(document.title);
  var comments = []; // Array of { id, selectedText, comment, section, paragraphContext, charOffset }
  var commentCounter = 0;
  var activeCommentId = null;

  // -- DOM references --
  var prose = document.querySelector('.prose');
  var commentsColumn = document.getElementById('comments-column');
  var saveFeedbackBtn = document.getElementById('save-feedback-btn');
  var clearCommentsBtn = document.getElementById('clear-comments-btn');

  // Floating UI elements (created on demand)
  var addCommentBtn = null;
  var commentInputContainer = null;
  var pendingSelection = null; // text: { type, text, range, rect, paragraph, charOffset, section } or image: { type, text, imgSrc, imgAlt, imgEl, rect, section }

  // -- Utility functions --

  function slugify(str) {
    return str.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
  }

  function generateId() {
    commentCounter++;
    return 'comment-' + Date.now() + '-' + commentCounter;
  }

  function truncate(str, len) {
    if (str.length <= len) return str;
    return str.slice(0, len - 1) + '\u2026';
  }

  function removeAllChildren(el) {
    while (el.firstChild) {
      el.removeChild(el.firstChild);
    }
  }

  function getNearestHeading(node) {
    var el = node.nodeType === 3 ? node.parentElement : node;
    while (el && el !== prose) {
      var prev = el.previousElementSibling;
      while (prev) {
        if (prev.tagName === 'H2' || prev.tagName === 'H3') {
          return prev.textContent.trim();
        }
        prev = prev.previousElementSibling;
      }
      el = el.parentElement;
    }
    return '';
  }

  function getContainingParagraph(node) {
    var el = node.nodeType === 3 ? node.parentElement : node;
    while (el && el !== prose) {
      if (el.tagName === 'P' || el.tagName === 'LI') return el;
      el = el.parentElement;
    }
    return null;
  }

  function getCharOffsetInParagraph(paragraph, range) {
    var walker = document.createTreeWalker(paragraph, NodeFilter.SHOW_TEXT, null, false);
    var offset = 0;
    var node;
    while ((node = walker.nextNode())) {
      if (node === range.startContainer) {
        return offset + range.startOffset;
      }
      offset += node.textContent.length;
    }
    return offset;
  }

  // -- Highlight wrapping --

  function wrapRangeWithMark(range, commentId) {
    var mark = document.createElement('mark');
    mark.className = 'comment-highlight';
    mark.dataset.commentId = commentId;
    try {
      range.surroundContents(mark);
    } catch (e) {
      var fragment = range.extractContents();
      mark.appendChild(fragment);
      range.insertNode(mark);
    }
    mark.addEventListener('click', function() {
      setActiveComment(commentId);
      scrollToCard(commentId);
    });
    return mark;
  }

  function findAndHighlightText(commentData) {
    var paragraphs = prose.querySelectorAll('p, li');
    var targetParagraph = null;
    for (var i = 0; i < paragraphs.length; i++) {
      var pText = paragraphs[i].textContent.slice(0, 100);
      if (pText === commentData.paragraphContext) {
        targetParagraph = paragraphs[i];
        break;
      }
    }
    if (!targetParagraph) return false;

    var fullText = targetParagraph.textContent;
    var searchText = commentData.selectedText;
    var expectedOffset = commentData.charOffset;

    var idx = fullText.indexOf(searchText, Math.max(0, expectedOffset - 5));
    if (idx === -1) {
      idx = fullText.indexOf(searchText);
    }
    if (idx === -1) return false;

    var walker = document.createTreeWalker(targetParagraph, NodeFilter.SHOW_TEXT, null, false);
    var currentOffset = 0;
    var startNode = null, startOff = 0, endNode = null, endOff = 0;
    var node;
    while ((node = walker.nextNode())) {
      var nodeLen = node.textContent.length;
      if (!startNode && currentOffset + nodeLen > idx) {
        startNode = node;
        startOff = idx - currentOffset;
      }
      if (startNode && currentOffset + nodeLen >= idx + searchText.length) {
        endNode = node;
        endOff = idx + searchText.length - currentOffset;
        break;
      }
      currentOffset += nodeLen;
    }

    if (!startNode || !endNode) return false;

    var range = document.createRange();
    range.setStart(startNode, startOff);
    range.setEnd(endNode, endOff);

    wrapRangeWithMark(range, commentData.id);
    return true;
  }

  function removeHighlight(commentId) {
    var marks = prose.querySelectorAll('mark[data-comment-id="' + commentId + '"]');
    marks.forEach(function(mark) {
      var parent = mark.parentNode;
      while (mark.firstChild) {
        parent.insertBefore(mark.firstChild, mark);
      }
      parent.removeChild(mark);
      parent.normalize();
    });
  }

  // -- Image comment helpers --

  function getImageForComment(commentData) {
    var imgs = prose.querySelectorAll('img');
    for (var i = 0; i < imgs.length; i++) {
      if (imgs[i].getAttribute('src') === commentData.imgSrc) return imgs[i];
    }
    return null;
  }

  function addImageHighlight(img, commentId) {
    img.classList.add('comment-highlight-img');
    var ids = (img.dataset.commentIds || '').split(' ').filter(Boolean);
    if (ids.indexOf(commentId) === -1) ids.push(commentId);
    img.dataset.commentIds = ids.join(' ');
    img.addEventListener('click', onImageClick);
  }

  function removeImageHighlight(img, commentId) {
    var ids = (img.dataset.commentIds || '').split(' ').filter(Boolean);
    ids = ids.filter(function(id) { return id !== commentId; });
    if (ids.length === 0) {
      img.classList.remove('comment-highlight-img');
      img.classList.remove('active');
      delete img.dataset.commentIds;
    } else {
      img.dataset.commentIds = ids.join(' ');
    }
  }

  function getAnchorForComment(commentData) {
    if (commentData.type === 'image') {
      return getImageForComment(commentData);
    }
    return prose.querySelector('mark[data-comment-id="' + commentData.id + '"]');
  }

  // -- Comment cards --

  function renderAllCards() {
    removeAllChildren(commentsColumn);

    var inlineCards = prose.querySelectorAll('.comment-card-inline');
    for (var i = 0; i < inlineCards.length; i++) {
      inlineCards[i].remove();
    }

    for (var j = 0; j < comments.length; j++) {
      createMarginCard(comments[j]);
      createInlineCard(comments[j]);
    }

    positionMarginCards();
  }

  function createMarginCard(commentData) {
    var card = document.createElement('div');
    card.className = 'comment-card';
    if (commentData.id === activeCommentId) card.classList.add('active');
    card.dataset.commentId = commentData.id;

    var quote = document.createElement('div');
    quote.className = 'comment-card-quote';
    if (commentData.type === 'image') {
      quote.textContent = 'Chart: ' + truncate(commentData.imgAlt || commentData.imgSrc, 50);
    } else {
      quote.textContent = '\u201c' + truncate(commentData.selectedText, 50) + '\u201d';
    }

    var text = document.createElement('div');
    text.className = 'comment-card-text';
    text.textContent = commentData.comment;

    var del = document.createElement('button');
    del.className = 'comment-card-delete';
    del.textContent = '\u00d7';
    del.title = 'Delete comment';
    del.addEventListener('click', function(e) {
      e.stopPropagation();
      deleteComment(commentData.id);
    });

    card.appendChild(quote);
    card.appendChild(text);
    card.appendChild(del);

    card.addEventListener('click', function() {
      setActiveComment(commentData.id);
      scrollToHighlight(commentData.id);
    });

    commentsColumn.appendChild(card);
  }

  function createInlineCard(commentData) {
    var anchor = getAnchorForComment(commentData);
    if (!anchor) return;

    var card = document.createElement('div');
    card.className = 'comment-card-inline';
    if (commentData.id === activeCommentId) card.classList.add('active');
    card.dataset.commentId = commentData.id;

    var quote = document.createElement('div');
    quote.className = 'comment-card-quote';
    if (commentData.type === 'image') {
      quote.textContent = 'Chart: ' + truncate(commentData.imgAlt || commentData.imgSrc, 50);
    } else {
      quote.textContent = '\u201c' + truncate(commentData.selectedText, 50) + '\u201d';
    }

    var text = document.createElement('div');
    text.className = 'comment-card-text';
    text.textContent = commentData.comment;

    var del = document.createElement('button');
    del.className = 'comment-card-delete';
    del.textContent = '\u00d7';
    del.title = 'Delete comment';
    del.addEventListener('click', function(e) {
      e.stopPropagation();
      deleteComment(commentData.id);
    });

    card.appendChild(quote);
    card.appendChild(text);
    card.appendChild(del);

    card.addEventListener('click', function() {
      setActiveComment(commentData.id);
      scrollToHighlight(commentData.id);
    });

    var parent = commentData.type === 'image' ? anchor : anchor.closest('p, li, h2, h3, img');
    if (parent && parent.parentNode) {
      parent.parentNode.insertBefore(card, parent.nextSibling);
    }
  }

  function positionMarginCards() {
    var cards = commentsColumn.querySelectorAll('.comment-card');
    var scrollY = window.scrollY || document.documentElement.scrollTop;
    var columnTop = commentsColumn.getBoundingClientRect().top + scrollY;
    var lastBottom = 0;

    for (var i = 0; i < cards.length; i++) {
      var card = cards[i];
      var commentId = card.dataset.commentId;
      var commentData = comments.find(function(c) { return c.id === commentId; });
      var anchor = commentData ? getAnchorForComment(commentData) : null;
      if (!anchor) {
        // Fallback: try mark element directly
        anchor = prose.querySelector('mark[data-comment-id="' + commentId + '"]');
      }
      if (!anchor) continue;

      var anchorRect = anchor.getBoundingClientRect();
      var desiredTop = anchorRect.top + scrollY - columnTop;

      if (desiredTop < lastBottom + 8) {
        desiredTop = lastBottom + 8;
      }

      card.style.top = desiredTop + 'px';
      lastBottom = desiredTop + card.offsetHeight;
    }
  }

  // -- Active comment highlighting --

  function setActiveComment(commentId) {
    activeCommentId = commentId;

    var highlights = prose.querySelectorAll('mark.comment-highlight');
    for (var i = 0; i < highlights.length; i++) {
      highlights[i].classList.toggle('active', highlights[i].dataset.commentId === commentId);
    }

    // Toggle active state on commented images
    var commentedImgs = prose.querySelectorAll('img.comment-highlight-img');
    for (var m = 0; m < commentedImgs.length; m++) {
      var imgIds = (commentedImgs[m].dataset.commentIds || '').split(' ');
      commentedImgs[m].classList.toggle('active', imgIds.indexOf(commentId) !== -1);
    }

    var marginCards = commentsColumn.querySelectorAll('.comment-card');
    for (var j = 0; j < marginCards.length; j++) {
      marginCards[j].classList.toggle('active', marginCards[j].dataset.commentId === commentId);
    }

    var inlineCards = prose.querySelectorAll('.comment-card-inline');
    for (var k = 0; k < inlineCards.length; k++) {
      inlineCards[k].classList.toggle('active', inlineCards[k].dataset.commentId === commentId);
    }
  }

  function scrollToCard(commentId) {
    var isWide = window.innerWidth >= 900;
    var card;
    if (isWide) {
      card = commentsColumn.querySelector('.comment-card[data-comment-id="' + commentId + '"]');
    } else {
      card = prose.querySelector('.comment-card-inline[data-comment-id="' + commentId + '"]');
    }
    if (card) {
      card.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }

  function scrollToHighlight(commentId) {
    var commentData = comments.find(function(c) { return c.id === commentId; });
    var anchor = commentData ? getAnchorForComment(commentData) : null;
    if (!anchor) {
      anchor = prose.querySelector('mark[data-comment-id="' + commentId + '"]');
    }
    if (anchor) {
      anchor.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }

  // -- Floating "Add Comment" button --

  function showAddCommentButton(x, y) {
    removeAddCommentButton();
    addCommentBtn = document.createElement('button');
    addCommentBtn.className = 'add-comment-btn';
    addCommentBtn.textContent = 'Comment';
    addCommentBtn.style.left = x + 'px';
    addCommentBtn.style.top = y + 'px';
    document.body.appendChild(addCommentBtn);

    addCommentBtn.addEventListener('mousedown', function(e) {
      e.preventDefault();
      e.stopPropagation();
    });
    addCommentBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      showCommentInput();
    });
  }

  function removeAddCommentButton() {
    if (addCommentBtn && addCommentBtn.parentNode) {
      addCommentBtn.parentNode.removeChild(addCommentBtn);
    }
    addCommentBtn = null;
  }

  // -- Comment input --

  function showCommentInput() {
    removeAddCommentButton();
    removeCommentInput();
    if (!pendingSelection) return;

    commentInputContainer = document.createElement('div');
    commentInputContainer.className = 'comment-input-container';

    var textarea = document.createElement('textarea');
    textarea.placeholder = 'Add your comment\u2026';
    textarea.rows = 2;

    var actions = document.createElement('div');
    actions.className = 'comment-input-actions';

    var cancelBtn = document.createElement('button');
    cancelBtn.className = 'comment-cancel-btn';
    cancelBtn.textContent = 'Cancel';

    var submitBtn = document.createElement('button');
    submitBtn.className = 'comment-submit-btn';
    submitBtn.textContent = 'Add';

    actions.appendChild(cancelBtn);
    actions.appendChild(submitBtn);

    commentInputContainer.appendChild(textarea);
    commentInputContainer.appendChild(actions);

    var scrollY = window.scrollY || document.documentElement.scrollTop;
    var scrollX = window.scrollX || document.documentElement.scrollLeft;
    var rect = pendingSelection.rect;
    var left = rect.right + scrollX + 8;
    var top = rect.top + scrollY;

    if (left + 288 > window.innerWidth + scrollX) {
      left = rect.left + scrollX - 296;
    }
    if (left < scrollX + 8) {
      left = scrollX + 8;
    }

    commentInputContainer.style.left = left + 'px';
    commentInputContainer.style.top = top + 'px';
    document.body.appendChild(commentInputContainer);
    textarea.focus();

    submitBtn.addEventListener('click', function() {
      submitComment(textarea.value.trim());
    });

    cancelBtn.addEventListener('click', function() {
      removeCommentInput();
      pendingSelection = null;
    });

    textarea.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        submitComment(textarea.value.trim());
      }
      if (e.key === 'Escape') {
        removeCommentInput();
        pendingSelection = null;
      }
    });
  }

  function removeCommentInput() {
    if (commentInputContainer && commentInputContainer.parentNode) {
      commentInputContainer.parentNode.removeChild(commentInputContainer);
    }
    commentInputContainer = null;
  }

  function submitComment(text) {
    if (!text || !pendingSelection) {
      removeCommentInput();
      pendingSelection = null;
      return;
    }

    var id = generateId();
    var commentData;

    if (pendingSelection.type === 'image') {
      commentData = {
        id: id,
        type: 'image',
        selectedText: pendingSelection.imgAlt || pendingSelection.imgSrc,
        comment: text,
        section: pendingSelection.section,
        imgSrc: pendingSelection.imgSrc,
        imgAlt: pendingSelection.imgAlt
      };
      addImageHighlight(pendingSelection.imgEl, id);
    } else {
      commentData = {
        id: id,
        type: 'text',
        selectedText: pendingSelection.text,
        comment: text,
        section: pendingSelection.section,
        paragraphContext: pendingSelection.paragraphContext,
        charOffset: pendingSelection.charOffset
      };
      try {
        var sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(pendingSelection.range);
        wrapRangeWithMark(pendingSelection.range, id);
      } catch(e) {
        findAndHighlightText(commentData);
      }
    }

    comments.push(commentData);
    saveToLocalStorage();
    removeCommentInput();
    pendingSelection = null;

    renderAllCards();
    setActiveComment(id);

    requestAnimationFrame(function() { positionMarginCards(); });
  }

  // -- Delete comment --

  function deleteComment(commentId) {
    var commentData = comments.find(function(c) { return c.id === commentId; });
    if (commentData && commentData.type === 'image') {
      var img = getImageForComment(commentData);
      if (img) removeImageHighlight(img, commentId);
    } else {
      removeHighlight(commentId);
    }
    comments = comments.filter(function(c) { return c.id !== commentId; });
    if (activeCommentId === commentId) activeCommentId = null;
    saveToLocalStorage();
    renderAllCards();
  }

  // -- Persistence --

  function saveToLocalStorage() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(comments));
    } catch(e) { /* silently fail */ }
  }

  function loadFromLocalStorage() {
    try {
      var stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        comments = JSON.parse(stored);
        for (var i = 0; i < comments.length; i++) {
          var parts = comments[i].id.split('-');
          var num = parseInt(parts[parts.length - 1], 10);
          if (num > commentCounter) commentCounter = num;
        }
      }
    } catch(e) {
      comments = [];
    }
  }

  function restoreComments() {
    loadFromLocalStorage();
    for (var i = 0; i < comments.length; i++) {
      if (comments[i].type === 'image') {
        var img = getImageForComment(comments[i]);
        if (img) addImageHighlight(img, comments[i].id);
      } else {
        findAndHighlightText(comments[i]);
      }
    }
    renderAllCards();
  }

  // -- Save feedback to file --

  function saveFeedback() {
    var exportData = {
      draft: document.title,
      timestamp: new Date().toISOString(),
      comments: comments.map(function(c) {
        var out = {
          id: c.id,
          type: c.type || 'text',
          selectedText: c.selectedText,
          comment: c.comment,
          section: c.section
        };
        if (c.type === 'image') {
          out.imgSrc = c.imgSrc;
          out.imgAlt = c.imgAlt;
        } else {
          out.paragraphContext = c.paragraphContext;
        }
        return out;
      })
    };

    var json = JSON.stringify(exportData, null, 2);

    if (window.showSaveFilePicker) {
      window.showSaveFilePicker({
        suggestedName: 'feedback.json',
        types: [{
          description: 'JSON files',
          accept: { 'application/json': ['.json'] }
        }]
      }).then(function(handle) {
        return handle.createWritable().then(function(writable) {
          return writable.write(json).then(function() {
            return writable.close();
          });
        });
      }).catch(function(e) {
        if (e.name === 'AbortError') return;
        downloadFallback(json);
      });
    } else {
      downloadFallback(json);
    }
  }

  function downloadFallback(json) {
    var blob = new Blob([json], { type: 'application/json' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'feedback.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // -- Clear all comments --

  function clearAllComments() {
    if (comments.length === 0) return;
    if (!confirm('Remove all comments? This cannot be undone.')) return;

    for (var i = 0; i < comments.length; i++) {
      if (comments[i].type === 'image') {
        var img = getImageForComment(comments[i]);
        if (img) removeImageHighlight(img, comments[i].id);
      } else {
        removeHighlight(comments[i].id);
      }
    }
    comments = [];
    activeCommentId = null;
    saveToLocalStorage();
    renderAllCards();
  }

  // -- Selection handling --

  function handleMouseUp(e) {
    if (e.target.closest('.add-comment-btn, .comment-input-container, .comment-card, .comment-card-inline, .draft-banner')) {
      return;
    }

    // Skip text selection handling when clicking on images (handled by onImageClick)
    if (e.target.tagName === 'IMG' && e.target.closest('.prose')) {
      return;
    }

    if (commentInputContainer && !e.target.closest('.comment-input-container')) {
      removeCommentInput();
      pendingSelection = null;
    }

    var sel = window.getSelection();
    if (!sel || sel.isCollapsed || !sel.rangeCount) {
      removeAddCommentButton();
      return;
    }

    var range = sel.getRangeAt(0);
    var text = sel.toString().trim();
    if (!text) {
      removeAddCommentButton();
      return;
    }

    var container = range.commonAncestorContainer;
    var inProse = (container.nodeType === 3 ? container.parentElement : container).closest('.prose');
    if (!inProse) {
      removeAddCommentButton();
      return;
    }

    var startInMark = range.startContainer.nodeType === 3
      ? range.startContainer.parentElement.closest('mark.comment-highlight')
      : range.startContainer.closest ? range.startContainer.closest('mark.comment-highlight') : null;
    if (startInMark) {
      removeAddCommentButton();
      return;
    }

    var paragraph = getContainingParagraph(range.startContainer);
    var paragraphContext = paragraph ? paragraph.textContent.slice(0, 100) : '';
    var charOffset = paragraph ? getCharOffsetInParagraph(paragraph, range) : 0;
    var section = getNearestHeading(range.startContainer);

    pendingSelection = {
      text: text,
      range: range.cloneRange(),
      rect: range.getBoundingClientRect(),
      paragraph: paragraph,
      paragraphContext: paragraphContext,
      charOffset: charOffset,
      section: section
    };

    var scrollY = window.scrollY || document.documentElement.scrollTop;
    var scrollX = window.scrollX || document.documentElement.scrollLeft;
    var rect = range.getBoundingClientRect();
    var btnX = rect.right + scrollX + 4;
    var btnY = rect.top + scrollY - 32;

    if (btnX + 80 > window.innerWidth + scrollX) {
      btnX = rect.left + scrollX;
    }
    if (btnY < scrollY) {
      btnY = rect.bottom + scrollY + 4;
    }

    showAddCommentButton(btnX, btnY);
  }

  function onImageClick(e) {
    var img = e.target;
    if (!img || img.tagName !== 'IMG' || !img.closest('.prose')) return;

    // If there's an open comment input, close it
    removeAddCommentButton();
    removeCommentInput();

    var section = getNearestHeading(img);
    var rect = img.getBoundingClientRect();

    pendingSelection = {
      type: 'image',
      text: img.alt || img.src,
      imgSrc: img.getAttribute('src'),
      imgAlt: img.getAttribute('alt') || '',
      imgEl: img,
      rect: rect,
      section: section
    };

    var scrollY = window.scrollY || document.documentElement.scrollTop;
    var scrollX = window.scrollX || document.documentElement.scrollLeft;
    var btnX = rect.right + scrollX - 80;
    var btnY = rect.top + scrollY + 8;

    showAddCommentButton(btnX, btnY);
    e.stopPropagation();
  }

  function handleClick(e) {
    if (e.target.closest('.comment-card, .comment-card-inline, mark.comment-highlight, .add-comment-btn, .comment-input-container') || (e.target.tagName === 'IMG' && e.target.closest('.prose'))) {
      return;
    }
    if (activeCommentId) {
      setActiveComment(null);
    }
  }

  function handleResizeOrScroll() {
    positionMarginCards();
  }

  // -- Wire up events --

  document.addEventListener('mouseup', handleMouseUp);
  document.addEventListener('click', handleClick);
  window.addEventListener('resize', handleResizeOrScroll);
  window.addEventListener('scroll', handleResizeOrScroll);

  saveFeedbackBtn.addEventListener('click', saveFeedback);
  clearCommentsBtn.addEventListener('click', clearAllComments);

  // -- Initialize --

  // Attach click handlers to all images in prose
  var proseImages = prose.querySelectorAll('img');
  for (var ii = 0; ii < proseImages.length; ii++) {
    proseImages[ii].addEventListener('click', onImageClick);
  }

  restoreComments();

  window.addEventListener('load', function() {
    positionMarginCards();
  });
})();
</script>

</body>
</html>
