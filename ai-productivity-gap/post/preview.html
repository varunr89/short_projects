<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Integral Problem: Why AI Isn't Moving the Productivity Needle</title>
<style>
  :root {
    --bg: #ffffff;
    --text: #333333;
    --text-muted: #666666;
    --link: #2563eb;
    --link-hover: #1d4ed8;
    --code-bg: #f3f4f6;
    --border-muted: rgba(102, 102, 102, 0.2);
  }

  @media (prefers-color-scheme: dark) {
    :root {
      --bg: #1a1a1a;
      --text: #e0e0e0;
      --text-muted: #a0a0a0;
      --link: #60a5fa;
      --link-hover: #93c5fd;
      --code-bg: #2d2d2d;
      --border-muted: rgba(160, 160, 160, 0.2);
    }
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.7;
    font-size: 1.125rem;
  }

  .container {
    max-width: 42rem;
    margin: 0 auto;
    padding: 2rem 1.5rem 4rem;
  }

  header {
    margin-bottom: 2rem;
  }

  header h1 {
    font-size: 1.875rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    line-height: 1.3;
  }

  header time {
    color: var(--text-muted);
    font-size: 0.875rem;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  }

  .prose p {
    margin-bottom: 1.25rem;
  }

  .prose h2 {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 2.5rem 0 1rem;
    line-height: 1.3;
  }

  .prose h3 {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 2rem 0 0.75rem;
    line-height: 1.3;
  }

  .prose a {
    color: var(--link);
    text-decoration: underline;
  }

  .prose a:hover {
    color: var(--link-hover);
  }

  .prose img {
    max-width: 100%;
    width: 100%;
    height: auto;
    border-radius: 0.5rem;
    margin: 1rem 0;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  @media (prefers-color-scheme: dark) {
    .prose img {
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
    }
  }

  .prose strong {
    font-weight: 600;
  }

  .prose em {
    font-style: italic;
  }

  .prose ul, .prose ol {
    margin-left: 1.5rem;
    margin-bottom: 1.25rem;
  }

  .prose li {
    margin-bottom: 0.35rem;
  }

  .prose blockquote {
    border-left: 3px solid var(--text-muted);
    padding-left: 1.25rem;
    margin: 1.5rem 0;
    font-style: italic;
    font-size: 1.2rem;
    color: var(--text-muted);
  }

  .prose blockquote p {
    margin-bottom: 0;
  }

  .sources {
    font-size: 0.8rem;
    line-height: 1.5;
    color: var(--text-muted);
  }

  .sources h4 {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-bottom: 0.5rem;
  }

  .sources ul {
    margin-left: 1.2rem;
  }

  .sources li {
    margin-bottom: 0.3rem;
  }

  footer {
    border-top: 1px solid var(--border-muted);
    margin-top: 3rem;
    padding-top: 1.5rem;
    color: var(--text-muted);
    font-size: 0.85rem;
  }

  .draft-banner {
    background: #fef3c7;
    color: #92400e;
    padding: 0.4rem 1rem;
    text-align: center;
    font-size: 0.8rem;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    position: sticky;
    top: 0;
    z-index: 100;
  }

  @media (prefers-color-scheme: dark) {
    .draft-banner {
      background: #422006;
      color: #fef3c7;
    }
  }

  /* ── Commenting system layout ── */

  .page-layout {
    display: flex;
    justify-content: center;
    gap: 0;
    position: relative;
  }

  .container {
    flex: 0 1 42rem;
    min-width: 0;
  }

  .comments-column {
    flex: 0 0 16rem;
    position: relative;
    padding: 2rem 1rem 4rem 0.5rem;
  }

  /* Draft banner buttons */
  .draft-banner {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
  }

  .draft-banner-label {
    font-weight: 600;
    letter-spacing: 0.05em;
  }

  .draft-banner button {
    background: rgba(146, 64, 14, 0.15);
    color: inherit;
    border: 1px solid rgba(146, 64, 14, 0.3);
    padding: 0.15rem 0.6rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-family: inherit;
    cursor: pointer;
    transition: background 0.15s;
  }

  .draft-banner button:hover {
    background: rgba(146, 64, 14, 0.25);
  }

  @media (prefers-color-scheme: dark) {
    .draft-banner button {
      background: rgba(254, 243, 199, 0.1);
      border-color: rgba(254, 243, 199, 0.2);
    }
    .draft-banner button:hover {
      background: rgba(254, 243, 199, 0.2);
    }
  }

  /* Comment highlights in the text */
  mark.comment-highlight {
    background: #fef9c3;
    border-bottom: 2px solid #fde68a;
    border-radius: 2px;
    padding: 0 1px;
    cursor: pointer;
    transition: background 0.15s;
  }

  mark.comment-highlight:hover,
  mark.comment-highlight.active {
    background: #fde68a;
  }

  @media (prefers-color-scheme: dark) {
    mark.comment-highlight {
      background: rgba(254, 249, 195, 0.2);
      border-bottom-color: rgba(253, 230, 138, 0.4);
      color: inherit;
    }
    mark.comment-highlight:hover,
    mark.comment-highlight.active {
      background: rgba(253, 230, 138, 0.35);
    }
  }

  /* Image comment highlights */
  .prose img {
    cursor: pointer;
    transition: outline 0.15s;
  }

  .prose img:hover {
    outline: 2px dashed rgba(245, 158, 11, 0.35);
    outline-offset: 3px;
  }

  .prose img.comment-highlight-img {
    outline: 3px solid #fde68a;
    outline-offset: 3px;
  }

  .prose img.comment-highlight-img:hover,
  .prose img.comment-highlight-img.active {
    outline-color: #f59e0b;
  }

  @media (prefers-color-scheme: dark) {
    .prose img:hover {
      outline-color: rgba(245, 158, 11, 0.25);
    }
    .prose img.comment-highlight-img {
      outline-color: rgba(253, 230, 138, 0.4);
    }
    .prose img.comment-highlight-img:hover,
    .prose img.comment-highlight-img.active {
      outline-color: #f59e0b;
    }
  }

  /* Margin comment cards */
  .comment-card {
    background: #fefce8;
    border: 1px solid #fde68a;
    border-radius: 6px;
    padding: 0.6rem 0.7rem;
    font-size: 0.8rem;
    line-height: 1.45;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
    position: absolute;
    left: 0;
    width: 15rem;
    cursor: pointer;
    transition: border-color 0.15s, box-shadow 0.15s, opacity 0.2s, transform 0.2s;
    opacity: 1;
    transform: translateX(0);
    animation: commentSlideIn 0.2s ease-out;
  }

  @keyframes commentSlideIn {
    from { opacity: 0; transform: translateX(8px); }
    to { opacity: 1; transform: translateX(0); }
  }

  .comment-card:hover {
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
  }

  .comment-card.active {
    border-color: #f59e0b;
    box-shadow: 0 2px 8px rgba(245, 158, 11, 0.2);
  }

  .comment-card-quote {
    font-style: italic;
    color: #92400e;
    margin-bottom: 0.35rem;
    word-break: break-word;
  }

  .comment-card-text {
    color: #333;
    word-break: break-word;
  }

  .comment-card-delete {
    position: absolute;
    top: 4px;
    right: 6px;
    background: none;
    border: none;
    font-size: 0.85rem;
    color: #b45309;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.15s;
    line-height: 1;
    padding: 2px 4px;
  }

  .comment-card:hover .comment-card-delete {
    opacity: 0.6;
  }

  .comment-card-delete:hover {
    opacity: 1 !important;
  }

  @media (prefers-color-scheme: dark) {
    .comment-card {
      background: #292214;
      border-color: rgba(253, 230, 138, 0.3);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }
    .comment-card.active {
      border-color: #f59e0b;
      box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
    }
    .comment-card-quote {
      color: #fcd34d;
    }
    .comment-card-text {
      color: #e0e0e0;
    }
    .comment-card-delete {
      color: #fcd34d;
    }
  }

  /* Floating "Add Comment" button */
  .add-comment-btn {
    position: absolute;
    z-index: 200;
    background: #f59e0b;
    color: #fff;
    border: none;
    padding: 0.3rem 0.75rem;
    border-radius: 999px;
    font-size: 0.78rem;
    font-family: system-ui, -apple-system, sans-serif;
    font-weight: 500;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    white-space: nowrap;
    transition: background 0.15s, transform 0.1s;
    animation: popIn 0.12s ease-out;
  }

  @keyframes popIn {
    from { transform: scale(0.85); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }

  .add-comment-btn:hover {
    background: #d97706;
  }

  /* Floating comment input */
  .comment-input-container {
    position: absolute;
    z-index: 200;
    background: #fefce8;
    border: 1px solid #fde68a;
    border-radius: 8px;
    padding: 0.6rem;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
    width: 18rem;
    animation: popIn 0.12s ease-out;
  }

  .comment-input-container textarea {
    width: 100%;
    border: 1px solid #e5e7eb;
    border-radius: 4px;
    padding: 0.4rem 0.5rem;
    font-size: 0.82rem;
    font-family: inherit;
    line-height: 1.4;
    resize: vertical;
    min-height: 3rem;
    color: #333;
    background: #fff;
  }

  .comment-input-container textarea:focus {
    outline: none;
    border-color: #f59e0b;
    box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.15);
  }

  .comment-input-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.4rem;
    margin-top: 0.4rem;
  }

  .comment-input-actions button {
    padding: 0.25rem 0.6rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-family: inherit;
    cursor: pointer;
    border: none;
  }

  .comment-submit-btn {
    background: #f59e0b;
    color: #fff;
    font-weight: 500;
  }

  .comment-submit-btn:hover {
    background: #d97706;
  }

  .comment-cancel-btn {
    background: #e5e7eb;
    color: #666;
  }

  .comment-cancel-btn:hover {
    background: #d1d5db;
  }

  @media (prefers-color-scheme: dark) {
    .comment-input-container {
      background: #292214;
      border-color: rgba(253, 230, 138, 0.3);
    }
    .comment-input-container textarea {
      background: #1a1a1a;
      color: #e0e0e0;
      border-color: #444;
    }
    .comment-input-container textarea:focus {
      border-color: #f59e0b;
    }
    .comment-cancel-btn {
      background: #444;
      color: #aaa;
    }
  }

  /* Inline comment cards for narrow screens */
  .comment-card-inline {
    background: #fefce8;
    border: 1px solid #fde68a;
    border-radius: 6px;
    padding: 0.5rem 0.65rem;
    font-size: 0.8rem;
    line-height: 1.45;
    margin: 0.5rem 0 1rem 0;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
    position: relative;
    cursor: pointer;
    transition: border-color 0.15s;
  }

  .comment-card-inline.active {
    border-color: #f59e0b;
  }

  .comment-card-inline .comment-card-quote {
    font-style: italic;
    color: #92400e;
    margin-bottom: 0.25rem;
  }

  .comment-card-inline .comment-card-text {
    color: #333;
  }

  .comment-card-inline .comment-card-delete {
    position: absolute;
    top: 4px;
    right: 6px;
    background: none;
    border: none;
    font-size: 0.85rem;
    color: #b45309;
    cursor: pointer;
    opacity: 0.4;
    line-height: 1;
    padding: 2px 4px;
  }

  .comment-card-inline .comment-card-delete:hover {
    opacity: 1;
  }

  @media (prefers-color-scheme: dark) {
    .comment-card-inline {
      background: #292214;
      border-color: rgba(253, 230, 138, 0.3);
    }
    .comment-card-inline.active {
      border-color: #f59e0b;
    }
    .comment-card-inline .comment-card-quote { color: #fcd34d; }
    .comment-card-inline .comment-card-text { color: #e0e0e0; }
    .comment-card-inline .comment-card-delete { color: #fcd34d; }
  }

  /* Wide screen: show margin column, hide inline cards */
  @media (min-width: 900px) {
    .comment-card-inline {
      display: none !important;
    }
  }

  /* Narrow screen: hide margin column, show inline cards */
  @media (max-width: 899px) {
    .comments-column {
      display: none !important;
    }
    .page-layout {
      display: block;
    }
  }
</style>
</head>
<body>

<div class="draft-banner">
  <span class="draft-banner-label">DRAFT PREVIEW</span>
  <button id="save-feedback-btn" title="Export comments as JSON">Save Feedback</button>
  <button id="clear-comments-btn" title="Remove all comments">Clear All Comments</button>
</div>

<div class="page-layout">

<div class="container">

<header>
  <h1>The Integral Problem: Why AI Isn't Moving the Productivity Needle</h1>
  <time>2026-02-17</time>
</header>

<div class="prose">

<p>I've spent the last two and a half years working across engineering and product teams at a large tech company, and in that time I've personally evaluated every major AI model release. I subscribe to every frontier AI service. I've tested each one end-to-end, not in sandboxed demos but on real work -- customer communications, data analysis, code generation, product planning.</p>

<p>The progression has been staggering. In early 2023, GPT-4 could pass the bar exam and ace the SAT, which felt like science fiction at the time. By mid-2024, models could see images and hold real-time voice conversations. By late 2024, they could autonomously control a computer desktop -- moving the mouse, clicking buttons, typing into applications. By early 2025, reasoning models were performing at PhD levels on physics and chemistry benchmarks. And just last week, GPT-5.2 derived an original result in theoretical physics -- a formula that physicists had assumed was zero for decades, discovered through a 12-hour scaffolded reasoning session and co-authored with researchers from the Institute for Advanced Study, Vanderbilt, Cambridge, and Harvard.</p>

<p>We went from models that could write passable haikus to autonomous agents contributing genuine scientific discoveries. In under three years.</p>

<p>And yet.</p>

<blockquote><p>In every team I worked with, at most 1 in 20 engineers had truly adopted AI into their daily workflow.</p></blockquote>

<p>Not 1 in 20 across the whole company. Not 1 in 20 among random employees. One in twenty among core engineering and product teams at a major technology company. Young, tech-savvy people who build software for a living. The people who should have been first.</p>

<p>That ratio is not an anecdote. It's empirical evidence. And once I started looking at the research, I found it everywhere.</p>

<h2>The mismatch</h2>

<p>Here's what makes this story more painful than a simple "people aren't adopting new technology" narrative.</p>

<img src="../charts/01_the_mismatch.png" alt="The Mismatch">

<p>The people who would gain the most from AI are the least likely to use the tools.</p>

<p>Brynjolfsson, Li, and Raymond studied 5,179 customer support agents at a Fortune 500 company and found that AI increased overall productivity by 14%. But the gains were wildly uneven. The bottom quintile -- the lowest-performing 20% of agents -- improved by 35%. The top quintile improved by roughly zero. The mechanism was straightforward: the AI had essentially encoded the knowledge and patterns of top performers and redistributed them downward.</p>

<p>Dell'Acqua and colleagues at Harvard ran a controlled study with 758 BCG consultants -- 7% of the firm's entire consulting force -- using GPT-4. Below-average consultants improved output quality by 43%. Above-average consultants improved by 17%. The performance gap between the top and bottom performers shrank from 22 percentage points to just 4.</p>

<p>Noy and Zhang found similar compression in a randomized writing experiment: ChatGPT reduced task completion time by 40% and increased quality by 18%, with the largest gains for the lowest performers.</p>

<p>The pattern is remarkably consistent across studies: AI is an equalizer. It lifts the floor far more than it raises the ceiling.</p>

<p>Now look at who actually uses it. Bick, Blandin, and Deming ran the first nationally representative U.S. survey on generative AI use and found a stark 2:1 education gradient -- about 40% of college-educated workers use AI at work, compared to about 20% of workers without a college degree. Pew Research confirmed the gap is widening, from 7 percentage points to 12 in a single year. Humlum and Vestergaard surveyed 18,000 Danish workers and found that higher-earning workers adopt at significantly higher rates, even controlling for experience and tenure.</p>

<p>The mismatch is almost perfectly inverted. The workers who gain 35-43% from AI adopt at half the rate of workers who gain 0-17%.</p>

<p>This is the thesis that makes everything else in this post click. It's not just that adoption is low. It's that adoption and potential gain are inversely correlated. The people standing to gain the most from these tools are the ones who aren't using them, and the people using them the most are the ones who need them least.</p>

<h2>The integral problem</h2>

<p>Think about organizational productivity as a curve. On the x-axis, employees ranked by percentile. On the y-axis, output. The total productivity of the organization is the area under that curve -- the integral.</p>

<img src="../charts/02_the_integral_problem.png" alt="The Integral Problem">

<p>When only the top 5% adopt AI, only the right tail of that curve shifts upward. The shaded area between the old curve and the new one is vanishingly small. The integral barely moves.</p>

<p>The math is straightforward but unforgiving. Realized gain at any point on the distribution equals the individual gain at that point multiplied by the adoption rate at that point. Both factors work against us. At the bottom of the distribution, where individual gains are highest (35-43%), adoption rates are lowest (around 20%). At the top, where adoption rates are highest (40-50%), individual gains are smallest (0-17%). You're multiplying big numbers by small numbers everywhere.</p>

<p>The result shows up in the macro data. Lab studies consistently find 14-40% productivity gains for specific tasks. But when Penn Wharton measured AI's actual impact on aggregate total factor productivity, they found 0.01 percentage points. That's a gap of roughly 1,000x between what's measured in controlled settings and what's showing up in the economy.</p>

<p>You can see AI everywhere except in the productivity statistics.</p>

<p>The Kansas City Fed published a study just this month noting that while higher AI adoption is associated with faster productivity growth across individual industries, "it explains little of the shift in aggregate contributions." The San Francisco Fed reached the same conclusion, explicitly invoking Robert Solow's 1987 observation that "you can see the computer age everywhere but in the productivity statistics." The Fed researchers found that observation remains relevant today. Kent Smetters at Penn Wharton put it more bluntly: "It's not electricity, it's not refrigeration -- it's not that transformative."</p>

<p>The Anthropic Economic Index measured AI usage patterns across enterprise deployments and found a Gini coefficient of 0.84 to 0.86. To put that in plain language: if you lined up every employee in an organization by how much they use AI, the distribution would look like a hockey stick lying on its back. A tiny cluster of power users at the far end accounts for almost all the usage. A Gini of 0.85 is more concentrated than income inequality in the most unequal country on Earth. Frontier workers in their dataset sent 6x more messages than the median enterprise user.</p>

<p>This is where the organizational theory comes in, and it matters more than most AI discussions acknowledge. Michael Kremer's O-Ring theory -- named after the Challenger disaster, where a single faulty component destroyed the entire shuttle -- models production as a multiplicative function across tasks. If any one person in the chain fails at their task, they destroy a disproportionate fraction of the final product's value. The implication: quality enters multiplicatively, so a team of nine excellent workers and one mediocre one produces far less than ten good workers. The cost of weak links is devastating in high-value production.</p>

<p>Ivan Steiner's foundational taxonomy of group tasks lays out the framework. Some tasks are disjunctive -- group output depends on the best member, like a quiz bowl where one person can answer. But most real-world organizational work is conjunctive (output limited by the weakest member, like a climbing team that goes only as fast as its slowest climber) or additive (output is the sum of everyone's contributions, like tug-of-war). In conjunctive and additive work, the floor and the average matter more than the ceiling.</p>

<p>Anderson and Sally, analyzing over 8,000 professional soccer matches, demonstrated this vividly. Soccer is a "weak link" sport. The 8th through 11th best players on a team predict results more than the star. Improving a team's worst player from the 38th to the 48th percentile is worth 13 goals per season. Improving the best player from the 82nd to the 92nd percentile is worth only 10. The bottom of the roster has higher leverage than the top.</p>

<p>Swaab and colleagues found something even more striking: too much top talent actually hurts team performance in interdependent sports. In basketball and football, once the ratio of elite to non-elite players exceeded roughly 2:1, coordination broke down. More stars produced fewer assists, fewer defensive rebounds, and lower field-goal percentages. In interdependent work -- which describes most knowledge work -- there is a point where more stars actively harms output.</p>

<p>Google's own Project Aristotle study of 180 internal teams found that "who is on a team matters less than how the team members interact." Psychological safety, not individual brilliance, was the single strongest predictor of team performance. Woolley and colleagues published similar findings in Science: a team's collective intelligence was not correlated with the average or maximum individual intelligence of its members.</p>

<p>I want to be honest about the counterargument. O'Boyle and Aguinis showed convincingly that individual performance in knowledge work follows a power-law distribution, not a normal one. Stars are real. Netflix's "talent density" philosophy explicitly embraces this: in creative work, the best performers may be 10x better than their peers. And for genuinely disjunctive tasks -- making a breakthrough discovery, closing a transformative deal -- the star model applies.</p>

<p>But here's the key: even under a power-law distribution, the body of the distribution still produces the majority of total output. If you have 1,000 engineers and 50 are 10x performers, those 50 contribute enormously per capita. But the other 950 still produce the majority of aggregate work. Price's Law says half of all output comes from the square root of contributors -- but the other half comes from everyone else. Remove them and you've halved your total output.</p>

<p>Most organizational work is not disjunctive. It's execution. Delivery. Operations. The kind of work where the aggregate matters, where the integral under the full curve determines what ships and what doesn't. And right now, that integral is barely moving.</p>

<h2>The capability-adoption gap</h2>

<p>The timeline makes the absurdity visible.</p>

<img src="../charts/03_capability_adoption_gap.png" alt="The Capability-Adoption Gap">

<p>In March 2023, GPT-4 passed the bar exam at the 90th percentile. Six months later, models could understand images. By May 2024, GPT-4o could hold real-time multimodal conversations with 320-millisecond voice response time. By September 2024, OpenAI's o1 was performing at PhD levels on physics and chemistry benchmarks. In October 2024, AI won a Nobel Prize. By early 2025, autonomous coding agents were shipping -- Claude Code, Codex CLI, GitHub Copilot's agent mode -- tools that could plan, write, debug, and deploy code with minimal human intervention. By mid-2025, Claude Opus 4 could sustain multi-hour autonomous work spanning thousands of steps. By late 2025, AI coding tools were achieving 77% on the SWE-bench benchmark, solving real-world software engineering problems that would challenge experienced developers.</p>

<p>The capability curve is practically vertical. And the adoption curve remains stubbornly flat.</p>

<p>McKinsey's 2025 State of AI survey found that 88% of organizations say they "use AI." But only about 7% have fully scaled it across operations. That gap between saying and doing is where productivity gains go to die.</p>

<p>Worklytics' 2025 AI Adoption Benchmarks found that 74% of companies show no tangible value from their AI investments. Not negative value. Just nothing measurable.</p>

<p>According to Lucidworks, 42% of companies abandoned most of their AI initiatives in 2025, up from 17% in 2024. Companies aren't ramping up. They're giving up.</p>

<p>McKinsey separately reported that over $1 trillion was spent on IT last year, yet more than 60% of companies reported no significant bottom-line impact from AI. AEI noted that roughly 80% of companies claim to use generative AI, yet just as many report no meaningful impact, with about 90% of transformative vertical use cases stuck in pilot mode.</p>

<p>The Solow paradox is repeating itself. Robert Solow observed in 1987 that you could see the computer age everywhere except in the productivity statistics. Here we are, nearly four decades later, and the same sentence works if you substitute "AI" for "computers." The capability exists. The tools are extraordinary. And the economic needle has barely budged.</p>

<h2>Why the gap exists</h2>

<p>I've watched this play out up close for over two years. Five problems keep surfacing.</p>

<h3>The learning curve is real</h3>

<p>I consider myself AI-fluent. I've been building with these tools since GPT-3. And even for me, getting truly productive with AI required significant effort.</p>

<p>I got lucky. During paternity leave, I had unstructured time to experiment. I'd hold my son in one arm and voice-transcribe prompts with the other. That sounds absurd, but it gave me something almost no working professional gets: hours of low-stakes experimentation. Trying things, failing, adjusting, building intuition. That's what it actually takes.</p>

<p>Most employees don't have that. They have meetings, deadlines, and sprint commitments. They get maybe 30 minutes to try a new tool before the next Slack message pulls them away. That's not enough to build fluency. It's barely enough to get through setup.</p>

<p>Humlum and Vestergaard found something that should alarm every manager trying to drive adoption. In their study of 18,000 Danish workers, even when researchers randomly informed workers that AI could halve their task time, it had no effect on usage behavior. None. Information alone doesn't drive adoption. Knowing the tool is powerful doesn't make people use it. The frictions -- lack of time, lack of training, lack of integration into existing workflows -- are causal barriers, not just correlates.</p>

<p>This is not an awareness problem. It's a friction problem.</p>

<h3>The belief deficit</h3>

<p>Most people's impression of AI comes from public failures. The lawyer who cited fake cases. The company that shipped AI-generated slop. The chatbot that told someone to eat rocks.</p>

<p>Can you blame someone for not wanting to stake their reputation on a tool they associate with embarrassing output?</p>

<p>Here's the thing: AI slop is a human problem, not an AI problem. It comes from people who don't review output. People who copy-paste without reading. People who were never taught how to prompt well or verify results. Bad work produced faster is still bad work. This problem has existed forever. AI just makes it more visible.</p>

<p>But the belief deficit is fixable. BCG found that positive sentiment toward AI jumps from 15% to 55% when employees receive strong leadership support. That's a 40-percentage-point swing driven entirely by whether leadership signals that AI is a serious, supported initiative rather than a fad. Only about 25% of frontline employees currently report having that level of support.</p>

<p>The fix isn't a newsletter. It isn't an all-hands deck. It's managers actively using AI in their own work, showing real examples from their own domain, and making it clear that AI-assisted work done well is valued -- not suspected.</p>

<h3>The training is useless</h3>

<p>Every AI training I attended was a marketing person demoing tools that employees couldn't actually use.</p>

<p>I'm not exaggerating. The demos are flashy. Someone shows ChatGPT writing a poem or summarizing a document. The audience nods politely. Then everyone goes back to their desks and nothing changes. Because the demo didn't teach them how to integrate AI into their workflow. It showed them what's theoretically possible in a vacuum.</p>

<p>The OECD published a report specifically on this problem. Most AI training is focused on AI specialists, not general workers. The prerequisites demanded for AI courses are higher than average, creating a barrier for the people who need basic literacy most. There's too much specialist training and not nearly enough general AI literacy.</p>

<p>BCG's numbers tell the story. Among regular AI users, 18% received no training at all. Among those who did get training, only 36% said it was enough. But here's the lever: employees who received 5 or more hours of training became regular AI users at a rate of 79%, compared to 67% for those with less. Twelve percentage points of adoption driven by the difference between serious training and token training.</p>

<p>Real training looks nothing like a demo. Real training means hands-on workshops where people build their own workflows with their own data. It means pairing AI-fluent employees with those who aren't. It means giving people real, protected, calendar-blocked time to experiment and fail. Not a 45-minute lunch-and-learn. Not a slide deck.</p>

<h3>Enterprise tools aren't ready</h3>

<p>Companies love to shove their own half-baked AI wrappers down employees' throats. "Use our internal copilot. It's approved by security." The internal copilot is a thin wrapper around a rate-limited API with a clunky interface and a model that's two generations behind.</p>

<p>Meanwhile, the tools that actually work -- Claude Code, Cursor, GitHub Copilot -- are either blocked or exist in a gray area. So what happens? Shadow AI. Employees use the good tools anyway, just on their personal machines, outside the security perimeter.</p>

<p>Microsoft's own Work Trend Index found that 78% of AI users bring their own AI tools to work. At small and medium businesses, that number rises to 80%. This is not a compliance failure. It's a product signal. When almost four out of five people bypass your approved tools, the problem is the approved tools.</p>

<p>This is an own goal. If your employees are using unauthorized tools, they're telling you something important: the sanctioned tools aren't good enough. Fix the tools, don't punish the behavior.</p>

<h3>Productivity is deeply personal</h3>

<p>Knowledge work is individual. The way I write code is different from how you write code. The way I draft documents, run analyses, manage projects -- all different. There is no single AI workflow that fits everyone.</p>

<p>Enterprise tools are designed as if one workflow works for all. It doesn't. A product manager needs AI for different things than a backend engineer, who needs it for different things than a data scientist, who needs it for different things than a marketing lead.</p>

<p>The Anthropic Gini data (0.84-0.86 concentration) isn't just measuring adoption rate. It's measuring the deeply personal nature of productivity. The power users aren't power users because they got a better demo. They're power users because they invested the time to build workflows that fit their specific work.</p>

<p>BCG's data on the "silicon ceiling" drives this home. Frontline worker adoption stalled at 51% in 2023 and hasn't moved since, despite two years of capability improvements and organizational push. The ceiling isn't a capability ceiling. It's a personalization ceiling. The tools haven't met these workers where they are.</p>

<h2>The agentic interface</h2>

<p>There's a useful analogy that keeps coming to mind. Think about the early internet. By the early 1990s, the underlying capability was extraordinary -- email, file transfer, hyperlinked documents spanning the globe. But using it meant memorizing terminal commands, understanding protocols, configuring network settings manually. The capability existed, but it was locked behind an interface that excluded almost everyone.</p>

<p>Then the browser shipped. Mosaic, then Netscape, then the explosion. The technology didn't change. The interface did. And that interface change is what turned the internet from an academic tool into the defining infrastructure of modern life.</p>

<p>AI is in its pre-browser moment right now. The capability is here -- it's remarkable, it's real, and it keeps getting better. But the dominant interfaces constrain what's possible.</p>

<p>Let me walk through the current landscape, because I think understanding the layers matters.</p>

<p>At the top of the power curve, you have CLI tools. Claude Code, Codex CLI, Aider. These live in your terminal and give AI direct access to the tools developers already use -- git, file systems, shell scripts, CI/CD pipelines. They're maximally powerful. Claude Code alone has crossed $1 billion in annualized revenue, faster than ChatGPT reached that milestone. In a UC San Diego/Cornell survey of professional developers in early 2026, Claude Code was the most-used agentic platform, edging out GitHub Copilot and Cursor.</p>

<p>One layer down, you have IDE integrations. Cursor reinvented itself with its own purpose-built model and multi-agent architecture where multiple AI agents work on different parts of a codebase simultaneously. It reached $1 billion in annualized revenue by late 2025, making it the fastest-growing SaaS company of all time from $1M to that milestone. GitHub Copilot sits on a distribution advantage no one else can match -- 100 million developers already in the ecosystem, 20 million cumulative users, 90% of the Fortune 100.</p>

<p>An interesting middle layer is emerging: TUIs -- terminal user interfaces. OpenCode, built by the SST team, exploded past 100,000 GitHub stars and 650,000 monthly active users in its first five months. It provides visual affordances -- panels, syntax highlighting, diff previews -- without leaving the terminal. It's the terminal with training wheels, a bridge between the raw power of CLI tools and the accessibility of graphical interfaces.</p>

<p>And at the bottom of the agentic spectrum, you have enterprise chat wrappers. Microsoft Copilot for M365, Google Gemini for Workspace. These layer AI on top of existing apps as a helper, not as an autonomous agent. The user remains the orchestrator of every step. They're roughly where web search was before the browser: the answers exist, but the interface makes it tedious to find them.</p>

<p>The terminology itself hasn't converged yet, which tells you how early this is. People call these tools "agentic IDEs" (RedMonk's Kate Holterhoff coined that one). Others say "agentic coding." Andrej Karpathy coined "vibe coding," which became Collins Dictionary's Word of the Year for 2025. I've seen "developer-grade AI," "AI workbench," and "agentic interface" all used to describe overlapping concepts. Semi Analysis published a piece titled "Claude Code is the Inflection Point," arguing it represents the interface breakthrough. The fact that we don't even have a settled term yet is itself a signal -- this category is still forming.</p>

<p>Here's a concrete example of what becomes possible when the interface gets out of the way. Two years ago, I drove a customer communication program reaching out to hundreds of one-off customers at a large tech company. It was slow, imprecise, and mostly ineffective. We were crafting generic messages and hoping they landed. Fast forward to today: using agentic AI tools, the same type of campaign can be surgical and prescriptive. Tailored outreach for each customer, specific recommendations based on their usage patterns, context-aware follow-ups that adapt based on response. The same workflow, transformed.</p>

<p>But it wasn't easy. It took trial and error. Hours of prompt iteration. Building custom pipelines. The effort pays off, but you have to invest it. The enterprise chat wrappers that promise "AI in a box" can't deliver this level of integration.</p>

<p>The investment signal is unmistakable. Claude Code at $1 billion ARR. Cursor at $1 billion ARR. OpenCode at 100K+ stars in months. Developers aren't waiting for enterprise tooling to catch up. They're building their own agentic workflows now.</p>

<p>The call to action here is simple: invest in agentic interfaces, not just chat wrappers. The browser didn't just make the internet easier to use. It made entirely new categories of work possible. Agentic AI interfaces will do the same, if we stop treating chat wrappers as the end state.</p>

<h2>What to do Monday morning</h2>

<p>I've laid out the problem. Here's what I'd actually do about it, starting this week.</p>

<h3>Mandate the AI path, with patience</h3>

<p>For new projects, default to the AI-assisted approach. Don't make it optional. But hold quality to the same bar as before. The goal is not to ship faster. The goal is to ship the same quality, faster, once people are up to speed.</p>

<p>Here's the part most managers skip: you have to budget for a temporary productivity dip. You cannot mandate AI and then penalize people for being slower while they learn. That kills adoption dead. Humlum's research showed that even knowing about AI's benefits doesn't change behavior when friction is high. You have to actively reduce the friction, which means time and patience.</p>

<p>John Ousterhout from Stanford calls AI a "tactical tornado." It lets you move fast, but speed without review produces slop. The fix is active review and tight feedback loops, not pulling back from AI. Quality control isn't optional. It's the entire point. AI without review is like shipping code without tests.</p>

<h3>Invest in applied training, not demos</h3>

<p>Stop doing demo-driven AI training. Today. It's worse than useless because it creates the illusion that you've invested in adoption.</p>

<p>BCG's data makes the case. Employees with 5 or more hours of training use AI regularly at a rate of 79%. Those with less: 67%. That 12-point gap is the difference between a team where AI is part of the workflow and a team where it's a novelty. And right now, 18% of regular AI users got no training at all -- imagine what they could do with structured support.</p>

<p>Real training means:</p>
<ul>
  <li>Hands-on workshops where people build workflows with their own data</li>
  <li>Pairing AI-fluent employees with those who are still learning</li>
  <li>Dedicated, protected time for experimentation -- not squeezed into existing sprints</li>
  <li>Follow-up sessions to share what worked and what didn't</li>
</ul>

<p>I became fluent during paternity leave because I had unstructured time. You can't give everyone paternity leave, but you can carve out space for the same kind of experimentation. Two hours a week. A Friday afternoon. Something.</p>

<h3>Embrace agentic interfaces</h3>

<p>The real productivity unlock is not the enterprise chat wrapper your company deployed last quarter. It's the agentic tools that integrate into real workflows -- terminal-based coding agents, IDE integrations with autonomous capabilities, tools that can read your codebase, run your tests, and iterate on failures without you babysitting every step.</p>

<p>I know this is a harder sell than "just add AI to Outlook." But the data is clear: the tools that are growing fastest -- Claude Code, Cursor, OpenCode -- are the ones that give users genuine agency, not just an autocomplete box in a sidebar. The enterprise wrappers that promise "AI in a box" aren't where the productivity gains live.</p>

<p>Give teams the budget and the permission to explore agentic tools. Solve for security at the platform level so you can say "yes" to the tools that actually work.</p>

<h3>Accept that productivity is personal</h3>

<p>Stop prescribing. There is no one-size-fits-all AI workflow. A mandate to "use tool X for task Y" will fail because it ignores how individual knowledge work actually is.</p>

<p>The Anthropic Gini coefficient of 0.84-0.86 is not just a measure of inequality. It's a measure of how personal AI productivity is. The power users found workflows that fit their specific work. You can't copy-paste that across a thousand people.</p>

<p>Instead: give people time and explicit permission to find their own use cases. Celebrate when someone discovers an unconventional workflow. Share wins across teams. Let adoption be organic, messy, and personal. The goal is to move the whole distribution rightward, not to force everyone through the same door.</p>

<h3>Enable, don't gate</h3>

<p>Stop battling shadow AI. You will lose.</p>

<p>If 78% of AI users are bringing their own tools to work, that tells you something fundamental about your approved tools. Instead of locking things down further, solve for data security and let people experiment.</p>

<p>There's a regulatory parallel here. The countries that over-regulate AI development slow down. The same dynamic plays out inside organizations. When you make it hard to use AI, people either don't use it or use it outside your visibility. Neither outcome is what you want.</p>

<p>Trust your employees. Build guardrails, not gates. There's a meaningful difference. The companies that win will be the ones that figured out how to say "yes, and here's how to do it safely" instead of "no."</p>

<h2>The bottom line</h2>

<p>The gap between AI capability and AI impact is not a technology problem. It's an organizational one. The tools are extraordinary. The research consistently shows 14-40% productivity gains in controlled settings. The question is why almost none of that is showing up at the organizational level.</p>

<p>The answer is the integral. When adoption is concentrated among the people who need it least, and absent among the people who would gain the most, the aggregate barely moves. The math doesn't care about your most productive engineer's 10x workflow. It cares about the full curve.</p>

<p>The integral only changes when the whole curve moves. Not just the tail.</p>

</div>

<footer>

<div class="sources">
<h4>Sources</h4>
<ul>
  <li><strong>Productivity gains by skill level:</strong> Brynjolfsson, Li, and Raymond (2023); Dell'Acqua et al. (2023); Noy and Zhang (2023)</li>
  <li><strong>Adoption demographics:</strong> Bick, Blandin, and Deming (2024); Pew Research (2024-2025); Humlum and Vestergaard (2024)</li>
  <li><strong>AI adoption:</strong> McKinsey, "The State of AI" (2024, 2025)</li>
  <li><strong>Employee-level usage:</strong> Worklytics, "2025 AI Adoption Benchmarks"</li>
  <li><strong>Usage concentration:</strong> Anthropic, "Economic Index" (September 2025)</li>
  <li><strong>Macro productivity:</strong> Penn Wharton Budget Model; Kansas City Fed (2026); San Francisco Fed</li>
  <li><strong>Organizational theory:</strong> Kremer, "The O-Ring Theory of Economic Development" (1993); Steiner, "Group Process and Productivity" (1972)</li>
  <li><strong>Team performance:</strong> Anderson and Sally, "The Numbers Game" (2013); Swaab et al. (2014); Woolley et al. (2010); Google Project Aristotle</li>
  <li><strong>Individual performance distribution:</strong> O'Boyle and Aguinis (2012)</li>
  <li><strong>Initiative abandonment:</strong> Lucidworks, AI Survey 2025</li>
  <li><strong>Shadow AI:</strong> Microsoft Work Trend Index (2024)</li>
  <li><strong>Training effectiveness:</strong> BCG, "AI at Work" (2024); OECD AI training report</li>
  <li><strong>Belief deficit:</strong> BCG leadership support findings (2024)</li>
  <li><strong>Agentic tools:</strong> Semi Analysis; UC San Diego/Cornell developer survey (2026)</li>
</ul>
</div>

</footer>

</div>

<div class="comments-column" id="comments-column"></div>

</div>

<script>
(function() {
  'use strict';

  // ── State ──
  var STORAGE_KEY = 'draft-comments-' + slugify(document.title);
  var comments = []; // Array of { id, selectedText, comment, section, paragraphContext, charOffset }
  var commentCounter = 0;
  var activeCommentId = null;

  // ── DOM references ──
  var prose = document.querySelector('.prose');
  var commentsColumn = document.getElementById('comments-column');
  var saveFeedbackBtn = document.getElementById('save-feedback-btn');
  var clearCommentsBtn = document.getElementById('clear-comments-btn');

  // Floating UI elements (created on demand)
  var addCommentBtn = null;
  var commentInputContainer = null;
  var pendingSelection = null; // text: { type, text, range, rect, paragraph, charOffset, section } or image: { type, text, imgSrc, imgAlt, imgEl, rect, section }

  // ── Utility functions ──

  function slugify(str) {
    return str.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
  }

  function generateId() {
    commentCounter++;
    return 'comment-' + Date.now() + '-' + commentCounter;
  }

  function truncate(str, len) {
    if (str.length <= len) return str;
    return str.slice(0, len - 1) + '\u2026';
  }

  function removeAllChildren(el) {
    while (el.firstChild) {
      el.removeChild(el.firstChild);
    }
  }

  function getNearestHeading(node) {
    var el = node.nodeType === 3 ? node.parentElement : node;
    while (el && el !== prose) {
      var prev = el.previousElementSibling;
      while (prev) {
        if (prev.tagName === 'H2' || prev.tagName === 'H3') {
          return prev.textContent.trim();
        }
        prev = prev.previousElementSibling;
      }
      el = el.parentElement;
    }
    return '';
  }

  function getContainingParagraph(node) {
    var el = node.nodeType === 3 ? node.parentElement : node;
    while (el && el !== prose) {
      if (el.tagName === 'P' || el.tagName === 'LI') return el;
      el = el.parentElement;
    }
    return null;
  }

  function getCharOffsetInParagraph(paragraph, range) {
    var walker = document.createTreeWalker(paragraph, NodeFilter.SHOW_TEXT, null, false);
    var offset = 0;
    var node;
    while ((node = walker.nextNode())) {
      if (node === range.startContainer) {
        return offset + range.startOffset;
      }
      offset += node.textContent.length;
    }
    return offset;
  }

  // ── Highlight wrapping ──

  function wrapRangeWithMark(range, commentId) {
    var mark = document.createElement('mark');
    mark.className = 'comment-highlight';
    mark.dataset.commentId = commentId;
    try {
      range.surroundContents(mark);
    } catch (e) {
      var fragment = range.extractContents();
      mark.appendChild(fragment);
      range.insertNode(mark);
    }
    mark.addEventListener('click', function() {
      setActiveComment(commentId);
      scrollToCard(commentId);
    });
    return mark;
  }

  function findAndHighlightText(commentData) {
    var paragraphs = prose.querySelectorAll('p, li');
    var targetParagraph = null;
    for (var i = 0; i < paragraphs.length; i++) {
      var pText = paragraphs[i].textContent.slice(0, 100);
      if (pText === commentData.paragraphContext) {
        targetParagraph = paragraphs[i];
        break;
      }
    }
    if (!targetParagraph) return false;

    var fullText = targetParagraph.textContent;
    var searchText = commentData.selectedText;
    var expectedOffset = commentData.charOffset;

    var idx = fullText.indexOf(searchText, Math.max(0, expectedOffset - 5));
    if (idx === -1) {
      idx = fullText.indexOf(searchText);
    }
    if (idx === -1) return false;

    var walker = document.createTreeWalker(targetParagraph, NodeFilter.SHOW_TEXT, null, false);
    var currentOffset = 0;
    var startNode = null, startOff = 0, endNode = null, endOff = 0;
    var node;
    while ((node = walker.nextNode())) {
      var nodeLen = node.textContent.length;
      if (!startNode && currentOffset + nodeLen > idx) {
        startNode = node;
        startOff = idx - currentOffset;
      }
      if (startNode && currentOffset + nodeLen >= idx + searchText.length) {
        endNode = node;
        endOff = idx + searchText.length - currentOffset;
        break;
      }
      currentOffset += nodeLen;
    }

    if (!startNode || !endNode) return false;

    var range = document.createRange();
    range.setStart(startNode, startOff);
    range.setEnd(endNode, endOff);

    wrapRangeWithMark(range, commentData.id);
    return true;
  }

  function removeHighlight(commentId) {
    var marks = prose.querySelectorAll('mark[data-comment-id="' + commentId + '"]');
    marks.forEach(function(mark) {
      var parent = mark.parentNode;
      while (mark.firstChild) {
        parent.insertBefore(mark.firstChild, mark);
      }
      parent.removeChild(mark);
      parent.normalize();
    });
  }

  // ── Image comment helpers ──

  function getImageForComment(commentData) {
    var imgs = prose.querySelectorAll('img');
    for (var i = 0; i < imgs.length; i++) {
      if (imgs[i].getAttribute('src') === commentData.imgSrc) return imgs[i];
    }
    return null;
  }

  function addImageHighlight(img, commentId) {
    img.classList.add('comment-highlight-img');
    var ids = (img.dataset.commentIds || '').split(' ').filter(Boolean);
    if (ids.indexOf(commentId) === -1) ids.push(commentId);
    img.dataset.commentIds = ids.join(' ');
    img.addEventListener('click', onImageClick);
  }

  function removeImageHighlight(img, commentId) {
    var ids = (img.dataset.commentIds || '').split(' ').filter(Boolean);
    ids = ids.filter(function(id) { return id !== commentId; });
    if (ids.length === 0) {
      img.classList.remove('comment-highlight-img');
      img.classList.remove('active');
      delete img.dataset.commentIds;
    } else {
      img.dataset.commentIds = ids.join(' ');
    }
  }

  function getAnchorForComment(commentData) {
    if (commentData.type === 'image') {
      return getImageForComment(commentData);
    }
    return prose.querySelector('mark[data-comment-id="' + commentData.id + '"]');
  }

  // ── Comment cards ──

  function renderAllCards() {
    removeAllChildren(commentsColumn);

    var inlineCards = prose.querySelectorAll('.comment-card-inline');
    for (var i = 0; i < inlineCards.length; i++) {
      inlineCards[i].remove();
    }

    for (var j = 0; j < comments.length; j++) {
      createMarginCard(comments[j]);
      createInlineCard(comments[j]);
    }

    positionMarginCards();
  }

  function createMarginCard(commentData) {
    var card = document.createElement('div');
    card.className = 'comment-card';
    if (commentData.id === activeCommentId) card.classList.add('active');
    card.dataset.commentId = commentData.id;

    var quote = document.createElement('div');
    quote.className = 'comment-card-quote';
    if (commentData.type === 'image') {
      quote.textContent = 'Chart: ' + truncate(commentData.imgAlt || commentData.imgSrc, 50);
    } else {
      quote.textContent = '\u201c' + truncate(commentData.selectedText, 50) + '\u201d';
    }

    var text = document.createElement('div');
    text.className = 'comment-card-text';
    text.textContent = commentData.comment;

    var del = document.createElement('button');
    del.className = 'comment-card-delete';
    del.textContent = '\u00d7';
    del.title = 'Delete comment';
    del.addEventListener('click', function(e) {
      e.stopPropagation();
      deleteComment(commentData.id);
    });

    card.appendChild(quote);
    card.appendChild(text);
    card.appendChild(del);

    card.addEventListener('click', function() {
      setActiveComment(commentData.id);
      scrollToHighlight(commentData.id);
    });

    commentsColumn.appendChild(card);
  }

  function createInlineCard(commentData) {
    var anchor = getAnchorForComment(commentData);
    if (!anchor) return;

    var card = document.createElement('div');
    card.className = 'comment-card-inline';
    if (commentData.id === activeCommentId) card.classList.add('active');
    card.dataset.commentId = commentData.id;

    var quote = document.createElement('div');
    quote.className = 'comment-card-quote';
    if (commentData.type === 'image') {
      quote.textContent = 'Chart: ' + truncate(commentData.imgAlt || commentData.imgSrc, 50);
    } else {
      quote.textContent = '\u201c' + truncate(commentData.selectedText, 50) + '\u201d';
    }

    var text = document.createElement('div');
    text.className = 'comment-card-text';
    text.textContent = commentData.comment;

    var del = document.createElement('button');
    del.className = 'comment-card-delete';
    del.textContent = '\u00d7';
    del.title = 'Delete comment';
    del.addEventListener('click', function(e) {
      e.stopPropagation();
      deleteComment(commentData.id);
    });

    card.appendChild(quote);
    card.appendChild(text);
    card.appendChild(del);

    card.addEventListener('click', function() {
      setActiveComment(commentData.id);
      scrollToHighlight(commentData.id);
    });

    var parent = commentData.type === 'image' ? anchor : anchor.closest('p, li, h2, h3, img');
    if (parent && parent.parentNode) {
      parent.parentNode.insertBefore(card, parent.nextSibling);
    }
  }

  function positionMarginCards() {
    var cards = commentsColumn.querySelectorAll('.comment-card');
    var scrollY = window.scrollY || document.documentElement.scrollTop;
    var columnTop = commentsColumn.getBoundingClientRect().top + scrollY;
    var lastBottom = 0;

    for (var i = 0; i < cards.length; i++) {
      var card = cards[i];
      var commentId = card.dataset.commentId;
      var commentData = comments.find(function(c) { return c.id === commentId; });
      var anchor = commentData ? getAnchorForComment(commentData) : null;
      if (!anchor) {
        // Fallback: try mark element directly
        anchor = prose.querySelector('mark[data-comment-id="' + commentId + '"]');
      }
      if (!anchor) continue;

      var anchorRect = anchor.getBoundingClientRect();
      var desiredTop = anchorRect.top + scrollY - columnTop;

      if (desiredTop < lastBottom + 8) {
        desiredTop = lastBottom + 8;
      }

      card.style.top = desiredTop + 'px';
      lastBottom = desiredTop + card.offsetHeight;
    }
  }

  // ── Active comment highlighting ──

  function setActiveComment(commentId) {
    activeCommentId = commentId;

    var highlights = prose.querySelectorAll('mark.comment-highlight');
    for (var i = 0; i < highlights.length; i++) {
      highlights[i].classList.toggle('active', highlights[i].dataset.commentId === commentId);
    }

    // Toggle active state on commented images
    var commentedImgs = prose.querySelectorAll('img.comment-highlight-img');
    for (var m = 0; m < commentedImgs.length; m++) {
      var imgIds = (commentedImgs[m].dataset.commentIds || '').split(' ');
      commentedImgs[m].classList.toggle('active', imgIds.indexOf(commentId) !== -1);
    }

    var marginCards = commentsColumn.querySelectorAll('.comment-card');
    for (var j = 0; j < marginCards.length; j++) {
      marginCards[j].classList.toggle('active', marginCards[j].dataset.commentId === commentId);
    }

    var inlineCards = prose.querySelectorAll('.comment-card-inline');
    for (var k = 0; k < inlineCards.length; k++) {
      inlineCards[k].classList.toggle('active', inlineCards[k].dataset.commentId === commentId);
    }
  }

  function scrollToCard(commentId) {
    var isWide = window.innerWidth >= 900;
    var card;
    if (isWide) {
      card = commentsColumn.querySelector('.comment-card[data-comment-id="' + commentId + '"]');
    } else {
      card = prose.querySelector('.comment-card-inline[data-comment-id="' + commentId + '"]');
    }
    if (card) {
      card.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }

  function scrollToHighlight(commentId) {
    var commentData = comments.find(function(c) { return c.id === commentId; });
    var anchor = commentData ? getAnchorForComment(commentData) : null;
    if (!anchor) {
      anchor = prose.querySelector('mark[data-comment-id="' + commentId + '"]');
    }
    if (anchor) {
      anchor.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }

  // ── Floating "Add Comment" button ──

  function showAddCommentButton(x, y) {
    removeAddCommentButton();
    addCommentBtn = document.createElement('button');
    addCommentBtn.className = 'add-comment-btn';
    addCommentBtn.textContent = 'Comment';
    addCommentBtn.style.left = x + 'px';
    addCommentBtn.style.top = y + 'px';
    document.body.appendChild(addCommentBtn);

    addCommentBtn.addEventListener('mousedown', function(e) {
      e.preventDefault();
      e.stopPropagation();
    });
    addCommentBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      showCommentInput();
    });
  }

  function removeAddCommentButton() {
    if (addCommentBtn && addCommentBtn.parentNode) {
      addCommentBtn.parentNode.removeChild(addCommentBtn);
    }
    addCommentBtn = null;
  }

  // ── Comment input ──

  function showCommentInput() {
    removeAddCommentButton();
    removeCommentInput();
    if (!pendingSelection) return;

    commentInputContainer = document.createElement('div');
    commentInputContainer.className = 'comment-input-container';

    var textarea = document.createElement('textarea');
    textarea.placeholder = 'Add your comment\u2026';
    textarea.rows = 2;

    var actions = document.createElement('div');
    actions.className = 'comment-input-actions';

    var cancelBtn = document.createElement('button');
    cancelBtn.className = 'comment-cancel-btn';
    cancelBtn.textContent = 'Cancel';

    var submitBtn = document.createElement('button');
    submitBtn.className = 'comment-submit-btn';
    submitBtn.textContent = 'Add';

    actions.appendChild(cancelBtn);
    actions.appendChild(submitBtn);

    commentInputContainer.appendChild(textarea);
    commentInputContainer.appendChild(actions);

    var scrollY = window.scrollY || document.documentElement.scrollTop;
    var scrollX = window.scrollX || document.documentElement.scrollLeft;
    var rect = pendingSelection.rect;
    var left = rect.right + scrollX + 8;
    var top = rect.top + scrollY;

    if (left + 288 > window.innerWidth + scrollX) {
      left = rect.left + scrollX - 296;
    }
    if (left < scrollX + 8) {
      left = scrollX + 8;
    }

    commentInputContainer.style.left = left + 'px';
    commentInputContainer.style.top = top + 'px';
    document.body.appendChild(commentInputContainer);
    textarea.focus();

    submitBtn.addEventListener('click', function() {
      submitComment(textarea.value.trim());
    });

    cancelBtn.addEventListener('click', function() {
      removeCommentInput();
      pendingSelection = null;
    });

    textarea.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        submitComment(textarea.value.trim());
      }
      if (e.key === 'Escape') {
        removeCommentInput();
        pendingSelection = null;
      }
    });
  }

  function removeCommentInput() {
    if (commentInputContainer && commentInputContainer.parentNode) {
      commentInputContainer.parentNode.removeChild(commentInputContainer);
    }
    commentInputContainer = null;
  }

  function submitComment(text) {
    if (!text || !pendingSelection) {
      removeCommentInput();
      pendingSelection = null;
      return;
    }

    var id = generateId();
    var commentData;

    if (pendingSelection.type === 'image') {
      commentData = {
        id: id,
        type: 'image',
        selectedText: pendingSelection.imgAlt || pendingSelection.imgSrc,
        comment: text,
        section: pendingSelection.section,
        imgSrc: pendingSelection.imgSrc,
        imgAlt: pendingSelection.imgAlt
      };
      addImageHighlight(pendingSelection.imgEl, id);
    } else {
      commentData = {
        id: id,
        type: 'text',
        selectedText: pendingSelection.text,
        comment: text,
        section: pendingSelection.section,
        paragraphContext: pendingSelection.paragraphContext,
        charOffset: pendingSelection.charOffset
      };
      try {
        var sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(pendingSelection.range);
        wrapRangeWithMark(pendingSelection.range, id);
      } catch(e) {
        findAndHighlightText(commentData);
      }
    }

    comments.push(commentData);
    saveToLocalStorage();
    removeCommentInput();
    pendingSelection = null;

    renderAllCards();
    setActiveComment(id);

    requestAnimationFrame(function() { positionMarginCards(); });
  }

  // ── Delete comment ──

  function deleteComment(commentId) {
    var commentData = comments.find(function(c) { return c.id === commentId; });
    if (commentData && commentData.type === 'image') {
      var img = getImageForComment(commentData);
      if (img) removeImageHighlight(img, commentId);
    } else {
      removeHighlight(commentId);
    }
    comments = comments.filter(function(c) { return c.id !== commentId; });
    if (activeCommentId === commentId) activeCommentId = null;
    saveToLocalStorage();
    renderAllCards();
  }

  // ── Persistence ──

  function saveToLocalStorage() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(comments));
    } catch(e) { /* silently fail */ }
  }

  function loadFromLocalStorage() {
    try {
      var stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        comments = JSON.parse(stored);
        for (var i = 0; i < comments.length; i++) {
          var parts = comments[i].id.split('-');
          var num = parseInt(parts[parts.length - 1], 10);
          if (num > commentCounter) commentCounter = num;
        }
      }
    } catch(e) {
      comments = [];
    }
  }

  function restoreComments() {
    loadFromLocalStorage();
    for (var i = 0; i < comments.length; i++) {
      if (comments[i].type === 'image') {
        var img = getImageForComment(comments[i]);
        if (img) addImageHighlight(img, comments[i].id);
      } else {
        findAndHighlightText(comments[i]);
      }
    }
    renderAllCards();
  }

  // ── Save feedback to file ──

  function saveFeedback() {
    var exportData = {
      draft: document.title,
      timestamp: new Date().toISOString(),
      comments: comments.map(function(c) {
        var out = {
          id: c.id,
          type: c.type || 'text',
          selectedText: c.selectedText,
          comment: c.comment,
          section: c.section
        };
        if (c.type === 'image') {
          out.imgSrc = c.imgSrc;
          out.imgAlt = c.imgAlt;
        } else {
          out.paragraphContext = c.paragraphContext;
        }
        return out;
      })
    };

    var json = JSON.stringify(exportData, null, 2);

    if (window.showSaveFilePicker) {
      window.showSaveFilePicker({
        suggestedName: 'feedback.json',
        types: [{
          description: 'JSON files',
          accept: { 'application/json': ['.json'] }
        }]
      }).then(function(handle) {
        return handle.createWritable().then(function(writable) {
          return writable.write(json).then(function() {
            return writable.close();
          });
        });
      }).catch(function(e) {
        if (e.name === 'AbortError') return;
        downloadFallback(json);
      });
    } else {
      downloadFallback(json);
    }
  }

  function downloadFallback(json) {
    var blob = new Blob([json], { type: 'application/json' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'feedback.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // ── Clear all comments ──

  function clearAllComments() {
    if (comments.length === 0) return;
    if (!confirm('Remove all comments? This cannot be undone.')) return;

    for (var i = 0; i < comments.length; i++) {
      if (comments[i].type === 'image') {
        var img = getImageForComment(comments[i]);
        if (img) removeImageHighlight(img, comments[i].id);
      } else {
        removeHighlight(comments[i].id);
      }
    }
    comments = [];
    activeCommentId = null;
    saveToLocalStorage();
    renderAllCards();
  }

  // ── Selection handling ──

  function handleMouseUp(e) {
    if (e.target.closest('.add-comment-btn, .comment-input-container, .comment-card, .comment-card-inline, .draft-banner')) {
      return;
    }

    // Skip text selection handling when clicking on images (handled by onImageClick)
    if (e.target.tagName === 'IMG' && e.target.closest('.prose')) {
      return;
    }

    if (commentInputContainer && !e.target.closest('.comment-input-container')) {
      removeCommentInput();
      pendingSelection = null;
    }

    var sel = window.getSelection();
    if (!sel || sel.isCollapsed || !sel.rangeCount) {
      removeAddCommentButton();
      return;
    }

    var range = sel.getRangeAt(0);
    var text = sel.toString().trim();
    if (!text) {
      removeAddCommentButton();
      return;
    }

    var container = range.commonAncestorContainer;
    var inProse = (container.nodeType === 3 ? container.parentElement : container).closest('.prose');
    if (!inProse) {
      removeAddCommentButton();
      return;
    }

    var startInMark = range.startContainer.nodeType === 3
      ? range.startContainer.parentElement.closest('mark.comment-highlight')
      : range.startContainer.closest ? range.startContainer.closest('mark.comment-highlight') : null;
    if (startInMark) {
      removeAddCommentButton();
      return;
    }

    var paragraph = getContainingParagraph(range.startContainer);
    var paragraphContext = paragraph ? paragraph.textContent.slice(0, 100) : '';
    var charOffset = paragraph ? getCharOffsetInParagraph(paragraph, range) : 0;
    var section = getNearestHeading(range.startContainer);

    pendingSelection = {
      text: text,
      range: range.cloneRange(),
      rect: range.getBoundingClientRect(),
      paragraph: paragraph,
      paragraphContext: paragraphContext,
      charOffset: charOffset,
      section: section
    };

    var scrollY = window.scrollY || document.documentElement.scrollTop;
    var scrollX = window.scrollX || document.documentElement.scrollLeft;
    var rect = range.getBoundingClientRect();
    var btnX = rect.right + scrollX + 4;
    var btnY = rect.top + scrollY - 32;

    if (btnX + 80 > window.innerWidth + scrollX) {
      btnX = rect.left + scrollX;
    }
    if (btnY < scrollY) {
      btnY = rect.bottom + scrollY + 4;
    }

    showAddCommentButton(btnX, btnY);
  }

  function onImageClick(e) {
    var img = e.target;
    if (!img || img.tagName !== 'IMG' || !img.closest('.prose')) return;

    // If there's an open comment input, close it
    removeAddCommentButton();
    removeCommentInput();

    var section = getNearestHeading(img);
    var rect = img.getBoundingClientRect();

    pendingSelection = {
      type: 'image',
      text: img.alt || img.src,
      imgSrc: img.getAttribute('src'),
      imgAlt: img.getAttribute('alt') || '',
      imgEl: img,
      rect: rect,
      section: section
    };

    var scrollY = window.scrollY || document.documentElement.scrollTop;
    var scrollX = window.scrollX || document.documentElement.scrollLeft;
    var btnX = rect.right + scrollX - 80;
    var btnY = rect.top + scrollY + 8;

    showAddCommentButton(btnX, btnY);
    e.stopPropagation();
  }

  function handleClick(e) {
    if (e.target.closest('.comment-card, .comment-card-inline, mark.comment-highlight, .add-comment-btn, .comment-input-container') || (e.target.tagName === 'IMG' && e.target.closest('.prose'))) {
      return;
    }
    if (activeCommentId) {
      setActiveComment(null);
    }
  }

  function handleResizeOrScroll() {
    positionMarginCards();
  }

  // ── Wire up events ──

  document.addEventListener('mouseup', handleMouseUp);
  document.addEventListener('click', handleClick);
  window.addEventListener('resize', handleResizeOrScroll);
  window.addEventListener('scroll', handleResizeOrScroll);

  saveFeedbackBtn.addEventListener('click', saveFeedback);
  clearCommentsBtn.addEventListener('click', clearAllComments);

  // ── Initialize ──

  // Attach click handlers to all images in prose
  var proseImages = prose.querySelectorAll('img');
  for (var ii = 0; ii < proseImages.length; ii++) {
    proseImages[ii].addEventListener('click', onImageClick);
  }

  restoreComments();

  window.addEventListener('load', function() {
    positionMarginCards();
  });
})();
</script>

</body>
</html>
